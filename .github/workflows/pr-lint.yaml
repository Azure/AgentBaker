name: Lint Pull Request Title

on:
  pull_request:
    branches:
      - master
      - dev
    types:
      - opened
      - edited
      - synchronize

jobs:
  lint-pr-title:
    permissions:
      pull-requests: write
      contents: read
    runs-on: ubuntu-latest
    steps:
      - id: lint-pr-title
        uses: Weburz/pr-lint-action@v0.0.1
        continue-on-error: true

      - if: steps.lint-pr-title.outcome == 'failure'
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;

            const comment = `## PR Title Lint Failed ❌

            **Current Title:** \`${prTitle}\`

            Your PR title doesn't follow the expected format. Please update your PR title to follow one of these patterns:

            ### Conventional Commits Format:
            - \`feat: add new feature\` - for new features
            - \`fix: resolve bug in component\` - for bug fixes
            - \`docs: update README\` - for documentation changes
            - \`refactor: improve code structure\` - for refactoring
            - \`test: add unit tests\` - for test additions
            - \`chore: update dependencies\` - for maintenance tasks
            - \`ci: update build pipeline\` - for CI/CD changes
            - \`style: fix code formatting\` - for style changes
            - \`perf: improve performance\` - for performance improvements

            ### Guidelines:
            - Use lowercase for the type and description
            - Keep the description concise but descriptive
            - Use imperative mood (e.g., "add" not "adds" or "added")
            - Don't end with a period

            ### Examples:
            - ✅ \`feat: add secure TLS bootstrapping for Windows nodes\`
            - ✅ \`fix: resolve kubelet certificate rotation issue\`
            - ✅ \`docs: update installation guide\`
            - ❌ \`Added new feature\`
            - ❌ \`Fix bug.\`
            - ❌ \`Update docs\`

            Please update your PR title and the lint check will run again automatically.`;

            // Check if we already commented on this PR to avoid spam
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('PR Title Lint Failed')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }

      - if: steps.lint-pr-title.outcome == 'failure'
        run: exit 1
