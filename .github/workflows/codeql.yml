name: codeql

on:
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - uses: actions/setup-go@v3
      with:
        go-version: '^1.18'
    - run: |
        set -euxo pipefail
        wget https://github.com/github/codeql-action/releases/download/codeql-bundle-20221123/codeql-bundle-linux64.tar.gz > /dev/null 2>&1
        tar -xvzf codeql-bundle-linux64.tar.gz > /dev/null 2>&1
        workdir=$(mktemp -d -t codeql-XXXXXXXXXX)
        cd codeql
        ./codeql database create $workdir/databases --language=go --source-root $GITHUB_WORKSPACE
        ./codeql database analyze $workdir/databases codeql/go-queries:codeql-suites/go-code-scanning.qls codeql/go-queries:codeql-suites/go-developer-happiness.qls codeql/go-queries:codeql-suites/go-lgtm-full.qls codeql/go-queries:codeql-suites/go-security-and-quality.qls codeql/go-queries:codeql-suites/go-security-extended.qls --format=sarif-latest --sarif-category=go --output=go-results.sarif
        ./codeql github upload-results --repository=Azure/AgentBaker --ref=$GITHUB_REF --commit=$GITHUB_SHA --sarif=go-results.sarif
        cd ..
        find -type f -name "go-results.sarif"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - uses: actions/upload-artifact@v3
      with:
        name: go-results.sarif
        path: $GITHUB_WORKSPACE/go-results.sarif
