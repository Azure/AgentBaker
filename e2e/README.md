# Agentbaker E2E Testing

This directory contains all files pertaining to our own implementation of an E2E testing framework for AgentBaker.

E2E testing for Linux is currently implemented using a Golang framework built from the ground-up. Note that we soon plan
on moving Windows over to this testing framework as well.

The goal of E2E testing with AgentBaker is to ensure that the node bootstrapping artifacts generted and returned by the
primary AgentBaker API not only contain *expected* content, but also contain *correct* content that can be used as-is to
bootstrap real Azure VMs so they can join real AKS clusters.

From a high-level, each E2E scenario makes a call out to the primary node-bootstrapping
API [GetLatestNodeBootstrapping](https://github.com/Azure/AgentBaker/blob/2e730b5a498c5be9b082d912fd08ac9346582db9/pkg/agent/bakerapi.go#L14)
with a set of parameters (represented by a NodeBootstrappingConfiugration) which define the given scenario to generate
CSE and custom data. A new VMSS containing a single VM will then be created and associated with an AKS cluster that is
already running in Azure. The CSE and custom data generated by AgentBaker will then be applied to the new VM so it can
bootstrap and register itself with the apiserver of the running cluster. Liveness and health checks and then run to make
sure the new VM's kubelet is posting NodeReady to the cluster's apiserver, and that workload pods can successfully be
run on it. Lastly, a set of validation commands are remotely executed on the VM to ensure its live state (file
existsnce, sysctl settings, etc.) is as expected.

## Running Locally

**Note: if you have changed code or artifacts used to generate custom data or custom script extension payloads, you
should first run `make generate` from the root of the AgentBaker repository.**

To run the Go implementation of the E2E test suite locally, simply use `e2e-local.sh`. This script will setup
the `go test` command for you.

Check [config.go](config/config.go) for the default configuration parameters. You can override these parameters by
setting ENV variables or by temporary changing the code.

```bash


<br>

`TAGS_TO_RUN=` may also optionally be set to specify a subset of the E2E scenarios to run based on the tags assigned to
each scenario. If `TAGS_TO_RUN` is not specified, all scenarios will be ran. Multiple tags can be specified as a
comma-separated list. In the case where multiple tags are specified, only scenarios which have all of the specified tags
will be ran. Check scenario files for available tags. Tag names are case-insensitive.

Example:
```bash
TAGS_TO_RUN="os=ubuntu2204,platform=arm64" ./e2e-local.sh
```

Furthermore, `TAGS_TO_SKIP` may also optionally be set to specify the set of scenarios which will be excluded
from the testing session as a commma-separated list. In the case where multiple tags are specified, only scenarios which
have none of the specified tags will be ran (this logic is different to TAGS_TO_RUN).

If both `TAGS_TO_RUN` and `TAGS_TO_SKIP` are  specified, `TAGS_TO_SKIP` will take precedence.

`KEEP_VMSS` can also be optionally specified to have the test suite retain the bootstrapped VM(s) for further debugging.
When this option is specified, the private SSH key used to connect to each VM will be included within each scenario's
log bundle respectively.

**Note that when using `e2e-local.sh`, a timeout value of 90 minutes is applied to the `go test` command.**

You may also run the test command with custom arguments yourself (assuming you've properly setup the required
environment variables) from within the `e2e/` directory like so:

```bash
go test -timeout 90m -v -run Test_All ./
```

## Package Structure

The top-level package of the Golang E2E implementation is named `e2e_test` and is entirely separate from all AgentBaker
packages.

The `e2e_test` package has a dependency on subpackage located in the [scenario](scenario/) directory. Package `scenario`
is where all E2E scenarios are defined, each in their own separate files. This package also defines
common [types](scenario/types.go) related to scenario and scenario configuration, as well as the hard-coded list of SIG
version IDs located in [images.go](scenario/images.go) used for testing different OS distros. Package `scenario` also
contains the implementation of common cluster selectors and mutators
within [clusterconfiguration.go](scenario/clusterconfiguration.go), though each scenario could define their own
implementations if needed.

The primary testing function is located in [suite_test.go](suite_test.go), which is run by `go test ...`.

## E2E VHDs.

Node images are pushed to Shared Image Gallery (SIG). Each image is tagged with branch name and build id.
By default E2E tests use latest version of images from SIG with `branch=refs/heads/master` tag.

### Using Arbitrary VHD Builds

If you'd like to run the E2E suite using a set of VHDs built from some arbitrary run of the VHD build pipeline in the
MSFT tenant, you can do so by specifying the SIG_VERSION_TAG_NAME and SIG_VERSION_TAG_VALUE environment variables.

***NOTE: This feature can only be used with test VHD builds, using builds from official build pipeline is not supported.
***

```bash
SIG_VERSION_TAG_NAME=buildId SIG_VERSION_TAG_VALUE=123456789 TAGS_TO_RUN="os=ubuntu2204" ./e2e-local.sh
```

### Registering New VHD SKUs for E2E Testing

When adding a new scenario which uses a VHD that doesn't currently have an associated entry in the base catalog, please
Build and add delete-lock to the underlying image version. If it's not done, the image version will be deleted after a few days
by the garbage collector.

## Scenarios

E2E scenarios can be configured with VMSS configuration mutators that change/set properties on the VMSS model used
to deploy the new VM to be bootstrapped. This is primarily useful when testing out different VM SKUs, especially for
GPU-enabled scenarios which affect which code paths AgentBaker will use to generate CSE and custom data

Further, in order to support E2E scenarios which test different underlying AKS cluster configurations, such as the
cluster's network plugin, each E2E scenario uses one of the predefined clusters. Same cluster can be reused in different 
test runs. If cluster doesn't exist a new one will be created automatically.

Lastly, E2E scenarios also consist of a list of live VM validators. Each live VM validator consists of a description, a
bash command which will actually be run on the newly bootstrapped VM, and an "asserter" function that will perform
assertions on the contents of both the stdout and stderr streams that result from the execution of the command. The
validators can be used to assert on numerous types of properties of the live VM, such as the live file system and kernel
state.

You can find all implemented scenarios in the [scenario](scenario/) pacakge within files prefixed with `scenario_`.
The `Scenario` struct definition can be found in [scenario/types.go](scenario/types.go).

### Implementation

To implement a new scenario, you need to do the following:

1. Create a new file in the scenario package directory named `scenario_<scenario-name>.go`
2. Within this new file, implement a private function with a representative name which returns a `*Scenario`
   representing the scenario's configuration
3. Add a call to the newly implemented function within the return value of the `scenarios()` function defined
   in [scenarios/init.go](scenario/init.go)
4. Implement any additional logic in the testing framework required by the new scenario

## Log Collection

Each E2E scenario will generate its own logs after execution. Currently, these logs consist of:

- `cluster-provision.log` - CSE execution log, retrieved from `/var/log/azure/aks/cluster-provision.log` (collected in
  success and CSE failure cases)
- `kubelet.log` - the kubelet systemd unit's logs retrived by running `journalctl -u kubelet` on the VM after
  bootstrapping has finished (collected in success and CSE failure cases)
- `vmssId.txt` - a single line text file containing the unique resource ID of the VMSS created by the respective
  scenario, mainly collected for the purposes of posthoc resource deletion (collected in all cases where the VMSS is
  able to be created)

These logs will be uploaded in a bundle of the format:

```bash
└── scenario-logs
    └── <scenario>
        ├── cluster-provision.log
        ├── kubelet.log
        ├── vmssId.txt
```

## Coverage report

After a PR is created in AgentBaker's repo on GitHub, a pipeline calculating code coverage changes will automatically
run.

We are utilizing [coveralls](https://coveralls.io/) to display the coverage report. The coverage report will be
available in the PR's description.
You can also view previous runs for the AgentBaker repo [here](https://coveralls.io/github/Azure/AgentBaker).

We calculate code coverage for both unit tests and E2E tests.

### E2E coverage report

To generate E2E coverage reports, we use code [coverage changes](https://go.dev/blog/integration-test-coverage)
introduced in Go 1.20.

Coverage report is generated by running AgentBaker's API server locally as a binary created with the -cover flag.
E2E tests are then ran against that binary.

The following packages are used during calculation of coverage for E2E tests:

````
- github.com/Azure/agentbaker/apiserver  
- github.com/Azure/agentbaker/cmd 
- github.com/Azure/agentbaker/cmd/starter
- github.com/Azure/agentbaker/pkg/agent
- github.com/Azure/agentbaker/pkg/agent/datamodel
- github.com/Azure/agentbaker/pkg/templates
````

#### Generating E2E coverage report locally

You can generate an E2E coverage report while running the E2E tests locally.
To do so, follow the steps below:

1. Build the AgentBaker server binary with -cover flag:

```bash
  cd cmd 
  go build -cover -o baker -covermode count 
  GOCOVERDIR=covdatafiles ./baker start &
```

2. Create directory for coverage report files

```bash
  mkdir -p covdatafiles
```     

3. Run the binary

```bash
  GOCOVERDIR=covdatafiles ./baker start &
```

4. Run the E2E tests locally

```bash
  /bin/bash e2e/e2e-local.sh
```

5. Stop the binary - once the tests finish executing, you have to stop the binary with exit code 0 to generate the
   report.
   See the docs [here](https://go.dev/testing/coverage/#panicprof).

```bash
  kill $(pgrep baker)
```

6. Display the coverage report within the terminal

```bash
  go tool covdata percent -i=./cmd/somedata
```
