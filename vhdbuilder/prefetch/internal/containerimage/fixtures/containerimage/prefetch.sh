#!/usr/bin/env bash
set -eux

prefetch() {
    local image=$1
    local files=$2
    
    mount_dir=$(mktemp -d)
    ctr -n k8s.io images mount "$image" "$mount_dir"

    for f in $files; do
        echo "prefetching $f in $image"
        path="$mount_dir/$f"
        stat -c %s "$path"
        cat "$path" > /dev/null
    done

    ctr -n k8s.io images unmount "$mount_dir"
}
prefetch "mcr.microsoft.com/oss/kubernetes/autoscaler/addon-resizer:1.8.22" ""
prefetch "mcr.microsoft.com/oss/kubernetes/metrics-server:v0.7.1" ""
prefetch "mcr.microsoft.com/oss/kubernetes/pause:3.6" ""
prefetch "mcr.microsoft.com/oss/kubernetes/coredns:v1.9.4-hotfix.20240704" ""
prefetch "mcr.microsoft.com/containernetworking/azure-cni:v1.5.35" ""
prefetch "mcr.microsoft.com/containernetworking/azure-cni:v1.6.5" ""
prefetch "mcr.microsoft.com/containernetworking/azure-cns:v1.4.52" ""
prefetch "mcr.microsoft.com/containernetworking/azure-cns:v1.5.35" ""
prefetch "mcr.microsoft.com/containernetworking/azure-cns:v1.6.5" ""
prefetch "mcr.microsoft.com/containernetworking/azure-ipam:v0.2.0" ""
prefetch "mcr.microsoft.com/containernetworking/cni-dropgz:v0.0.20" ""
prefetch "mcr.microsoft.com/containernetworking/cni-dropgz:v0.1.4" ""
prefetch "mcr.microsoft.com/containernetworking/cni-dropgz:v0.2.0" ""
prefetch "mcr.microsoft.com/containernetworking/azure-npm:v1.5.34" ""
prefetch "mcr.microsoft.com/oss/kubernetes/apiserver-network-proxy/agent:v0.1.6-hotfix.20240116" ""
prefetch "mcr.microsoft.com/oss/kubernetes/apiserver-network-proxy/agent:v0.30.3-hotfix.20240819" ""
prefetch "mcr.microsoft.com/oss/kubernetes-csi/secrets-store/driver:v1.4.5" ""
prefetch "mcr.microsoft.com/oss/azure/secrets-store/provider-azure:v1.5.3" ""
prefetch "mcr.microsoft.com/azuremonitor/containerinsights/ciprod:3.1.23" ""
prefetch "mcr.microsoft.com/aks/msi/addon-token-adapter:master.221118.2" ""
prefetch "mcr.microsoft.com/azuremonitor/containerinsights/ciprod/prometheus-collector/images:6.9.0-main-07-22-2024-2e3dfb56" ""
prefetch "mcr.microsoft.com/azuremonitor/containerinsights/ciprod/prometheus-collector/images:6.9.0-main-07-22-2024-2e3dfb56-targetallocator" ""
prefetch "mcr.microsoft.com/azuremonitor/containerinsights/ciprod/prometheus-collector/images:6.9.0-main-07-22-2024-2e3dfb56-cfg" ""
prefetch "mcr.microsoft.com/oss/kubernetes/kube-state-metrics:v2.11.0" ""
prefetch "mcr.microsoft.com/oss/cilium/cilium:1.13.13-4" ""
prefetch "mcr.microsoft.com/oss/cilium/cilium:1.14.10-2" ""
prefetch "mcr.microsoft.com/oss/kubernetes/azure-cloud-node-manager:v1.27.20" ""
prefetch "mcr.microsoft.com/oss/kubernetes/azure-cloud-node-manager:v1.28.11" ""
prefetch "mcr.microsoft.com/oss/kubernetes/azure-cloud-node-manager:v1.29.9" ""
prefetch "mcr.microsoft.com/oss/kubernetes/azure-cloud-node-manager:v1.30.5" ""
prefetch "mcr.microsoft.com/oss/kubernetes/azure-cloud-node-manager:v1.31.0" ""
prefetch "mcr.microsoft.com/oss/kubernetes/autoscaler/cluster-proportional-autoscaler:v1.8.9" ""
prefetch "mcr.microsoft.com/aks/ip-masq-agent-v2:v0.1.13" ""
prefetch "mcr.microsoft.com/oss/kubernetes-csi/azuredisk-csi:v1.28.10" ""
prefetch "mcr.microsoft.com/oss/kubernetes-csi/azuredisk-csi:v1.29.9" ""
prefetch "mcr.microsoft.com/oss/kubernetes-csi/azuredisk-csi:v1.30.4" ""
prefetch "mcr.microsoft.com/oss/kubernetes-csi/azurefile-csi:v1.28.12" ""
prefetch "mcr.microsoft.com/oss/kubernetes-csi/azurefile-csi:v1.29.8" ""
prefetch "mcr.microsoft.com/oss/kubernetes-csi/azurefile-csi:v1.30.5" ""
prefetch "mcr.microsoft.com/oss/kubernetes-csi/blob-csi:v1.22.8" ""
prefetch "mcr.microsoft.com/oss/kubernetes-csi/blob-csi:v1.23.7" ""
prefetch "mcr.microsoft.com/oss/kubernetes-csi/blob-csi:v1.24.3" ""
prefetch "mcr.microsoft.com/oss/kubernetes-csi/livenessprobe:v2.13.1" ""
prefetch "mcr.microsoft.com/oss/kubernetes-csi/livenessprobe:v2.12.0" ""
prefetch "mcr.microsoft.com/oss/kubernetes-csi/csi-node-driver-registrar:v2.11.1" ""
prefetch "mcr.microsoft.com/oss/kubernetes-csi/csi-node-driver-registrar:v2.10.1" ""
prefetch "mcr.microsoft.com/oss/open-policy-agent/gatekeeper:v3.17.1" ""
prefetch "mcr.microsoft.com/oss/open-policy-agent/gatekeeper:v3.16.3" ""
prefetch "mcr.microsoft.com/azure-policy/policy-kubernetes-addon-prod:1.7.1" ""
prefetch "mcr.microsoft.com/azure-policy/policy-kubernetes-addon-prod:1.5.0" ""
prefetch "mcr.microsoft.com/azure-policy/policy-kubernetes-webhook:1.7.1" ""
prefetch "mcr.microsoft.com/azure-policy/policy-kubernetes-webhook:1.5.0" ""
prefetch "mcr.microsoft.com/aks/aks-node-ca-watcher:master.240820.1" ""
prefetch "mcr.microsoft.com/oss/kubernetes/windows-gmsa-webhook:v0.7.1" ""
prefetch "mcr.microsoft.com/oss/kubernetes/kube-proxy:v1.27.16" ""
prefetch "mcr.microsoft.com/oss/kubernetes/kube-proxy:v1.28.13" ""
prefetch "mcr.microsoft.com/oss/kubernetes/kube-proxy:v1.29.8" ""
prefetch "mcr.microsoft.com/oss/kubernetes/kube-proxy:v1.30.4" ""