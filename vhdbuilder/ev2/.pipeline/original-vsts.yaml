name: $(SourceBranchName).$(date:yyMMdd)$(rev:.r)
parameters:
  PACKAGE: 'packageparameter' # pass some parameters, define as you like
  previous: 'test_and_build' # just make sure ev2 build run at last
  artifact: 'drop' # it is the deploy artifact name, not ev2 artifact name

phases:
  - phase: build_vhd
    steps:
      - task: PublishBuildArtifacts@1
        displayName: 'Publish vhd artifacts'
        inputs:
          artifactName: 'vhd'
      # store some variables into files, later copy them into ev2 repo
      - bash: |
          cat <<EOF > vhd-publishing-info.json
              {
                  "vhd_url" : "vhd_url",
                  "os_name" : "OS_NAME",
                  "sku_name" : "sku_name",
                  "offer_name" : "OFFER_NAME",
                  "windows_version" : "windows_version"
              }
        displayName: set vhd publishing info
  - phase: ev2_build
    dependsOn:
      - ${{ parameters.previous }}
    steps:
      - task: DownloadBuildArtifacts@0
        displayName: Download vhd
        inputs:
          downloadType: 'single'
          artifactName: 'vhd'
          downloadPath: 'ev2/vhd/artifacts'

      - task: DownloadBuildArtifacts@0
        displayName: Download Common
        inputs:
          downloadType: 'single'
          artifactName: '${{ parameters.artifact }}'
          downloadPath: 'ev2-drop'

      - script: |
          mkdir -p ev2/vhd/common

          cp -rf ev2-drop/${{ parameters.artifact }}/* ev2/vhd/common
        displayName: Copy common

      - powershell: |
          $env:BUILD_BUILDNUMBER | Out-File ev2/sample.Image/package/version.txt
          ./tools/ev2ab.ps1 ev2 $(Build.ArtifactStagingDirectory)/ev2.artifacts
        displayName: Build ev2 artifacts

      - task: PublishBuildArtifacts@1
        displayName: 'Publish ev2 sample.Image artifacts'
        inputs:
          pathtoPublish: $(Build.ArtifactStagingDirectory)/ev2.artifacts/sample.Image
          artifactName: 'ev2.sample.Image'
