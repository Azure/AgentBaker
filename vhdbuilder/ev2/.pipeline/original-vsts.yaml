name: $(SourceBranchName).$(date:yyMMdd)$(rev:.r)

phases:
  - phase: build_vhd
    queue:
      name: ace-test
      timeoutInMinutes: 120
    steps:
      # store some variables into files, later copy them into ev2 repo
      - bash: |
          echo "I was here" > vhd-publishing-info.json
          ls
        displayName: set vhd publishing info

      - task: PublishBuildArtifacts@1
        displayName: 'Publish vhd artifacts'
        inputs:
          artifactName: 'vhd'
          targetPath: 'vhd-publishing-info.json'

  - phase: ev2_build
    dependsOn: build_vhd
    queue:
      name: ace-test
      timeoutInMinutes: 120
    steps:
      - bash: |
          ls
          displayName: ls directory
      - task: DownloadBuildArtifacts@0
        displayName: Download vhd
        inputs:
          downloadType: 'single'
          artifactName: 'vhd'
          downloadPath: 'ev2/vhd/artifacts'

      - powershell: |
          $env:BUILD_BUILDNUMBER | Out-File ev2/vhd/version.txt
          ./tools/ev2ab.ps1 ev2 $(Build.ArtifactStagingDirectory)/ev2.artifacts
        displayName: Build ev2 artifacts

      - task: PublishBuildArtifacts@1
        displayName: 'Publish ev2 vhd artifacts'
        inputs:
          pathtoPublish: $(Build.ArtifactStagingDirectory)/ev2.artifacts/vhd
          artifactName: 'ev2.vhd'
