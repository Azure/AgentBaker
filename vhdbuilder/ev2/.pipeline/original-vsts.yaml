name: $(SourceBranchName).$(date:yyMMdd)$(rev:.r)

phases:
  - phase: build_vhd
    steps:
      - task: PublishBuildArtifacts@1
        displayName: 'Publish vhd artifacts'
        inputs:
          artifactName: 'vhd'
      # store some variables into files, later copy them into ev2 repo
      - bash: |
          cat <<EOF > vhd-publishing-info.json
              {
                  "vhd_url" : "vhd_url",
                  "os_name" : "OS_NAME",
                  "sku_name" : "sku_name",
                  "offer_name" : "OFFER_NAME",
                  "windows_version" : "windows_version"
              }
        displayName: set vhd publishing info
  - phase: ev2_build
    steps:
      - task: DownloadBuildArtifacts@0
        displayName: Download vhd
        inputs:
          downloadType: 'single'
          artifactName: 'vhd'
          downloadPath: 'ev2/vhd/artifacts'

      - powershell: |
          $env:BUILD_BUILDNUMBER | Out-File ev2/vhd/version.txt
          ./tools/ev2ab.ps1 ev2 $(Build.ArtifactStagingDirectory)/ev2.artifacts
        displayName: Build ev2 artifacts

      - task: PublishBuildArtifacts@1
        displayName: 'Publish ev2 vhd artifacts'
        inputs:
          pathtoPublish: $(Build.ArtifactStagingDirectory)/ev2.artifacts/vhd
          artifactName: 'ev2.vhd'
