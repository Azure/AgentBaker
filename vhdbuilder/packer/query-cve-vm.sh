#!/usr/bin/env bash
set -uo pipefail

CVE_REPORT_DIRNAME=/opt/azure/containers
CVE_REPORT_PATH=${CVE_REPORT_DIRNAME}/cve-report.out

UMSI_PRINCIPAL_ID=${1}
UMSI_CLIENT_ID=${2}
ACCOUNT_NAME=${3}
KUSTO_ENDPOINT=${4}
KUSTO_DATABASE=${5}
KUSTO_TABLE=${6}
COMMIT_HASH=${7}
STORAGE_ACCOUNT_NAME=${8}
CVE_REPORT_OUTPUT_NAME=${9}
CVE_REPORT_CONTAINER_NAME=${10}
AZURE_MSI_RESOURCE_STRING=${11}


MODULE_NAME="vuln-to-kusto-vhd"
GO_ARCH="amd64"

# hardcoded for now
LOOKBACK_HOURS=12h
SEVERITY="HIGH"

# redirect stderr for correct script failure detection
{
    sudo apt-get install -y ca-certificates curl apt-transport-https lsb-release gnupg
    curl -sL https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
    echo "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/azure-cli.list
    sudo apt-get update -y && sudo apt-get upgrade -y
    sudo apt-get install -y azure-cli
} 2>&1

az login --identity --username $UMSI_PRINCIPAL_ID

# pull vuln-to-kusto binary
az storage blob download --auth-mode login --account-name ${ACCOUNT_NAME} -c vuln-to-kusto \
    --name ${MODULE_VERSION}/${MODULE_NAME}_linux_${GO_ARCH} \
    --file ./${MODULE_NAME} 2>&1
chmod a+x ${MODULE_NAME}

./vuln-to-kusto-vhd query-report ${LOOKBACK_HOURS} ${COMMIT_HASH} \
    --severity ${SEVERITY} \
    --kusto-endpoint ${KUSTO_ENDPOINT} \
    --kusto-database ${KUSTO_DATABASE} \
    --kusto-table ${KUSTO_TABLE} \
    --kusto-managed-identity-client-id=${UMSI_CLIENT_ID} > ${CVE_REPORT_PATH}

if [[ $? -ne 0 ]] && [[ -f ${CVE_REPORT_PATH} ]]; then
    echo "vuln-to-kusto-vhd query-report cmd found CVEs"
    az login --identity --username $AZURE_MSI_RESOURCE_STRING
    az storage blob upload --file ${CVE_REPORT_PATH} \
        --container-name ${CVE_REPORT_CONTAINER_NAME} \
        --name ${CVE_REPORT_OUTPUT_NAME} \
        --account-name ${STORAGE_ACCOUNT_NAME} \
        --auth-mode login
fi
