name: PR_$(Date:yyyyMMdd)$(Rev:.r)_$(Build.SourceBranchName)_$(BuildID)
trigger: none
pr:
  branches:
    include:
      - master
      - dev
  paths:
    include:
      - parts/windows
    exclude:
      - vhdbuilder/release-notes
      - /**/*.md
      - .github/**
      - e2e/scenario_test.go
      - parts/common/components.json

pool:
  name: $(AZURE_POOL_NAME)

# Some templates use POOL_NAME instead of AZURE_POOL_NAME, so set POOL_NAME here just in case.
variables:
  VHD_BUILD_ID: $(Build.BuildId)
  LOCATION: $(PACKER_BUILD_LOCATION)
  POOL_NAME: $(AZURE_POOL_NAME)

# Use variable group "ab-windows-ame-tenant" and link it to the pipeline "AKS Windows VHD Build"
# Use variable group "ab-windows-ame-tenant" and link it to the pipeline "AKS Windows VHD Build - PR check-in gate"
# Use variable group "ab-windows-ms-tenant" and link it to the pipeline "[TEST All VHDs] AKS Windows VHD Build - Msft Tenant"

stages:
  - template: ./templates/.build-and-test-windows-vhds-template.yaml
    parameters:
      vhddebug: False
      dryrun: False
      buildVmSize: Standard_D4ds_v5
      build2019containerd: True
      build2022containerd: False
      build2022containerdgen2: True
      build23H2: False
      build23H2gen2: True
      overrideBranch: master
      useOverrides: False
