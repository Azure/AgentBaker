name: $(Date:yyyyMMdd)$(Rev:.r)_$(Build.SourceBranchName)_$(BuildID)
trigger: none
pr:
  branches:
    include:
    - master
    - dev
  paths:
    include:
    - schemas
    - vhdbuilder/packer
    - vhdbuilder/scripts/linux
    - .pipelines/.vsts-vhd-builder.yaml
    - .pipelines/templates/.builder-release-template.yaml
    - parts/linux/*
    - packer.mk
    exclude:
    - vhdbuilder/packer/*.ps1
    - vhdbuilder/packer/**/*.ps1
    - vhdbuilder/packer/*windows*
    - vhdbuilder/packer/**/*windows*

pool:
  name: $(POOL_NAME)

variables:
  - group: aks-vuln-to-kusto
  - group: "AKS Node SIG UA Token (KV)"

stages:
  - template: ./templates/.build-and-test-linux-vhd-template.yaml
    parameters:
      useOverrides: ${{ parameters.useOverrides }}
      overrideBranch: ${{ parameters.overrideBranch }}
      dryrun: ${{ parameters.dryrun }}
      vhddebug: ${{ parameters.vhddebug }}
      stageName: 2204_gen2_containerd
      imageName:
      artifactName: 2204-gen2-containerd
      build: true
      osSku: Ubuntu
      osVersion: "22.04"
      imgPublisher: Canonical
      imgOffer: 0001-com-ubuntu-server-jammy
      imgSku: 22_04-lts-gen2
      imgVersion: latest
      hyperVGeneration: V2
      buildVmSize: Standard_D16ds_v5
      featureFlags: None
      containerRuntime: containerd
      architecture: X86_64
      enableFips: False
      enableTrustedLaunch: False
      sgxInstall: True
      enableCGroupV2: false

  - template: ./templates/.build-and-test-linux-vhd-template.yaml
    parameters:
      useOverrides: ${{ parameters.useOverrides }}
      overrideBranch: ${{ parameters.overrideBranch }}
      dryrun: ${{ parameters.dryrun }}
      vhddebug: ${{ parameters.vhddebug }}
      stageName: 1804gen2gpucontainerd
      imageName: 1804gen2gpucontainerd
      artifactName: 1804-gen2-gpu-containerd
      build: true
      osSku: Ubuntu
      osVersion: "18.04"
      imgPublisher: Canonical
      imgOffer: UbuntuServer
      imgSku: 18_04-LTS-GEN2
      imgVersion: latest
      hyperVGeneration: V2
      buildVmSize: Standard_NC4as_T4_v3
      featureFlags: fullgpudaemon
      containerRuntime: containerd
      architecture: X86_64
      enableFips: false
      enableTrustedLaunch: False
      sgxInstall: true
      enableCGroupV2: false

  - template: ./templates/.build-and-test-linux-vhd-template.yaml
    parameters:
      useOverrides: ${{ parameters.useOverrides }}
      overrideBranch: ${{ parameters.overrideBranch }}
      dryrun: ${{ parameters.dryrun }}
      vhddebug: ${{ parameters.vhddebug }}
      stageName: marinerv2_gen2
      imageName:
      artifactName: marinerv2-gen2
      build: true
      osSku: CBLMariner
      osVersion: "V2"
      imgPublisher: MicrosoftCBLMariner
      imgOffer: cbl-mariner
      imgSku: cbl-mariner-2-gen2
      imgVersion: latest
      hyperVGeneration: V2
      buildVmSize: Standard_D16ds_v5
      featureFlags: None
      containerRuntime: containerd
      architecture: X86_64
      enableFips: false
      enableTrustedLaunch: false
      sgxInstall: true
      enableCGroupV2: false
