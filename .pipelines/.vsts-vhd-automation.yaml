pool:
  # uncomment this if the auto teardown pool is down.
  # vmImage: ubuntu-22.04
  name: $(1ES_DevInfra_Auto_TearDown_Pool_Name)

parameters:
- name: ImageBump
  displayName: Image Bump + Branch Cutting
  type: boolean
  default: true
- name: ReleaseNotes
  displayName: Release Notes
  type: boolean
  default: true
- name: ArtifactTrigger
  displayName: SIG Artifact Trigger
  type: boolean
  default: true
- name: VHDProdTrigger
  displayName: VHD Production Trigger
  type: boolean
  default: true

steps:
- bash: |
        echo "Removing existing go environment"
        sudo rm -r /usr/local/go
        GOLANG_VERSION=$(curl -s 'https://go.dev/VERSION?m=text')
        echo "Downloading ${GOLANG_VERSION}"
        curl -O "https://dl.google.com/go/${GOLANG_VERSION}.linux-amd64.tar.gz"

        echo "unpacking go"
        sudo mkdir -p /usr/local/go
        sudo chown -R "$(whoami):$(whoami)" /usr/local/go 
        sudo tar -xvf "${GOLANG_VERSION}.linux-amd64.tar.gz" -C /usr/local
        rm "${GOLANG_VERSION}.linux-amd64.tar.gz"
  displayName: 'Clean up go environment'
- bash: |
        az extension add -n azure-devops
        echo $MAPPED_ADO_PAT | az devops login --organization=https://dev.azure.com/msazure
        az devops configure --defaults organization=https://dev.azure.com/msazure project=CloudNativeCompute
  env:
        MAPPED_ADO_PAT: $(ADO_PAT)
  displayName: 'az devops login'
- bash: |
        echo "Bumping windows VHD base image version"
        /bin/bash vhdbuilder/scripts/windows/automate_version_bump.sh $MAPPED_GITHUB_PAT
  env:
        MAPPED_GITHUB_PAT: $(TMP_GITHUB_PAT)
  displayName: 'Image Version Bumping'
  condition: eq('${{ parameters.ImageBump }}', true)
- bash: |
        echo "Triggering windows VHD production pipeline (containerd & docker)"
        /bin/bash vhdbuilder/scripts/windows/automate_vhd_production_trigger.sh
  displayName: 'Windows VHD Production'
  condition: eq('${{ parameters.VHDProdTrigger }}', true)