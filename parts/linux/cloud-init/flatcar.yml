variant: flatcar
version: 1.1.0
systemd:
  units:
    - name: ignition-bootcmds.service
      enabled: true
      contents: |
        [Unit]
        Description=Ignition Early Boot Commands
        DefaultDependencies=no
        After=local-fs.target
        Before=sysinit.target
        ConditionPathExists=/etc/ignition-bootcmds.sh

        [Service]
        Type=oneshot
        ExecStart=-/etc/ignition-bootcmds.sh

        [Install]
        WantedBy=sysinit.target

    - name: ignition-file-extract.service
      enabled: true
      contents: |
        [Unit]
        Description=Extract Ignition file payload
        DefaultDependencies=no
        After=local-fs.target
        Before=sysinit.target ignition-bootcmds.service
        ConditionPathExists=/var/lib/ignition/ignition-files.tar

        [Service]
        Type=oneshot
        ExecStart=tar -xvf /var/lib/ignition/ignition-files.tar -C /
        ExecStart=rm -f /var/lib/ignition/ignition-files.tar
        ExecStart=systemctl daemon-reload
        RemainAfterExit=yes

        [Install]
        WantedBy=sysinit.target
# Workaround for Issue 9: ACL (Azure Container Linux) uses Azure Linux's
# systemd v255 which lacks systemd-preset-all.service (introduced in v256),
# and /etc/machine-id is pre-populated so ConditionFirstBoot=yes is false.
# This means Ignition's "enabled: true" preset file (20-ignition.preset) is
# never processed, leaving services disabled. We create the enable symlinks
# explicitly via storage.links to bypass the broken preset mechanism entirely.
# This is safe on upstream Flatcar too â€” overwrite: true handles the case
# where presets work and the symlinks already exist.
storage:
  links:
    - path: /etc/systemd/system/sysinit.target.wants/ignition-bootcmds.service
      target: /etc/systemd/system/ignition-bootcmds.service
      overwrite: true
    - path: /etc/systemd/system/sysinit.target.wants/ignition-file-extract.service
      target: /etc/systemd/system/ignition-file-extract.service
      overwrite: true
