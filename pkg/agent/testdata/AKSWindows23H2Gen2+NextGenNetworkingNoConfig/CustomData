<#
    .SYNOPSIS
        Provisions VM as a Kubernetes agent.

    .DESCRIPTION
        Provisions VM as a Kubernetes agent.

        The parameters passed in are required, and will vary per-deployment.

        Notes on modifying this file:
        - This file extension is PS1, but it is actually used as a template from pkg/engine/template_generator.go
        - All of the lines that have braces in them will be modified. Please do not change them here, change them in the Go sources
        - Single quotes are forbidden, they are reserved to delineate the different members for the ARM template concat() call
        - windowscsehelper.ps1 contains basic util functions. It will be compressed to a zip file and then be converted to base64 encoding
          string and stored in $zippedFiles. Reason: This script is a template and has some limitations.
        - All other scripts will be packaged and published in a single package. It will be downloaded in provisioning VM.
          Reason: CustomData has length limitation 87380.
        - ProvisioningScriptsPackage contains scripts to start kubelet, kubeproxy, etc. The source is https://github.com/Azure/aks-engine/tree/master/staging/provisioning/windows
#>
[CmdletBinding(DefaultParameterSetName="Standard")]
param(
    [parameter(Mandatory=$true)]
    [ValidateNotNullOrEmpty()]
    $AgentKey,

    [parameter(Mandatory=$true)]
    [ValidateNotNullOrEmpty()]
    $AADClientSecret, # base64

    # C:\AzureData\provision.complete
    # MUST keep generating this file when CSE is done and do not change the name
    #  - It is used to avoid running CSE multiple times
    #  - Some customers use this file to check if CSE is done
    [parameter(Mandatory=$true)]
    [ValidateNotNullOrEmpty()]
    $CSEResultFilePath
)

# In an ideal world, all these values would be passed to this script in parameters. However, we don't live in an ideal world.
# https://learn.microsoft.com/en-gb/troubleshoot/windows-client/shell-experience/command-line-string-limitation

$MasterIP = "uttestdom-dns-5d7c849e.hcp.southcentralus.azmk8s.io"
$KubeDnsServiceIp="10.0.0.10"
$MasterFQDNPrefix="uttestdom"
$Location="southcentralus"

$TargetEnvironment="AzurePublicCloud"
$AADClientId="ClientID"
$NetworkAPIVersion="2018-08-01"

# Do not parse the start time from $LogFile to simplify the logic
$StartTime=Get-Date
$global:ExitCode=0
$global:ErrorMessage=""

# These globals will not change between nodes in the same cluster, so they are not
# passed as powershell parameters

## SSH public keys to add to authorized_keys
$global:SSHKeys = @( "testsshkey" )

## Certificates generated by aks-engine
$global:CACertificate = ""
$global:AgentCertificate = ""

## Download sources provided by aks-engine
$global:KubeBinariesPackageSASURL = ""
$global:WindowsKubeBinariesURL = ""
$global:KubeBinariesVersion = "1.29.0"
$global:ContainerdUrl = "https://k8swin.blob.core.windows.net/k8s-windows/containerd/containerplat-aks-test-0.0.8.zip"
$global:ContainerdSdnPluginUrl = ""

## Docker Version
$global:DockerVersion = "20.10.9"

## ContainerD Usage
$global:DefaultContainerdWindowsSandboxIsolation = "process"
$global:ContainerdWindowsRuntimeHandlers = ""

## VM configuration passed by Azure
$global:WindowsTelemetryGUID = "fb801154-36b9-41bc-89c2-f4d4f05472b0"

$global:TenantId = "tenantID"

$global:SubscriptionId = "subID"
$global:ResourceGroup = "resourceGroupName"
$global:VmType = "vmss"
$global:SubnetName = "aks-subnet"
# NOTE: MasterSubnet is still referenced by `kubeletstart.ps1` and `windowsnodereset.ps1`
# for case of Kubenet
$global:MasterSubnet = ""
$global:SecurityGroupName = "aks-agentpool-36873793-nsg"
$global:VNetName = "aks-vnet-36873793"
$global:RouteTableName = "aks-agentpool-36873793-routetable"
$global:PrimaryAvailabilitySetName = ""
$global:PrimaryScaleSetName = "akswpool2"

$global:KubeClusterCIDR = "10.240.0.0/16"
$global:KubeServiceCIDR = "10.0.0.0/16"
$global:VNetCIDR = "10.0.0.0/8"

$global:KubeletNodeLabels = "agentpool=wpool2,kubernetes.azure.com/agentpool=wpool2,kubernetes.azure.com/node-image-version=AKSWindows-2019-17763.1577.201111"

$global:KubeletConfigArgs = @( "--address=0.0.0.0", "--anonymous-auth=false", "--authentication-token-webhook=true", "--authorization-mode=Webhook", "--azure-container-registry-config=c:\k\azure.json", "--cgroups-per-qos=false", "--client-ca-file=c:\k\ca.crt", "--cloud-config=c:\k\azure.json", "--cloud-provider=azure", "--cluster-dns=10.0.0.10", "--cluster-domain=cluster.local", "--enforce-node-allocatable=", "--event-qps=0", "--eviction-hard=", "--feature-gates=RotateKubeletServerCertificate=true", "--hairpin-mode=promiscuous-bridge", "--image-gc-high-threshold=85", "--image-gc-low-threshold=80", "--kube-reserved=cpu=100m,memory=1843Mi", "--kubeconfig=c:\k\config", "--max-pods=30", "--network-plugin=cni", "--node-status-update-frequency=10s", "--pod-infra-container-image=mcr.microsoft.com/oss/v2/kubernetes/pause:3.6", "--pod-max-pids=-1", "--read-only-port=0", "--resolv-conf=""", "--rotate-certificates=false", "--streaming-connection-idle-timeout=4h", "--system-reserved=memory=2Gi", "--tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256" )
$global:KubeproxyConfigArgs = @( "--metrics-bind-address=0.0.0.0:10249" )

$global:KubeproxyFeatureGates = @( "WinDSR=true", "WinOverlay=false" )

$global:UseManagedIdentityExtension = "false"
$global:UseInstanceMetadata = "true"

$global:LoadBalancerSku = "Standard"
$global:ExcludeMasterFromStandardLB = "true"

$global:PrivateEgressProxyAddress = ""

# Windows defaults, not changed by aks-engine
$global:CacheDir = "c:\akse-cache"
$global:KubeDir = "c:\k"
$global:HNSModule = [Io.path]::Combine("$global:KubeDir", "hns.v2.psm1")

$global:KubeDnsSearchPath = "svc.cluster.local"

$global:CNIPath = [Io.path]::Combine("$global:KubeDir", "cni")
$global:NetworkMode = "L2Bridge"
$global:CNIConfig = [Io.path]::Combine($global:CNIPath, "config", "`$global:NetworkMode.conf")
$global:CNIConfigPath = [Io.path]::Combine("$global:CNIPath", "config")


$global:AzureCNIDir = [Io.path]::Combine("$global:KubeDir", "azurecni")
$global:AzureCNIBinDir = [Io.path]::Combine("$global:AzureCNIDir", "bin")
$global:AzureCNIConfDir = [Io.path]::Combine("$global:AzureCNIDir", "netconf")

# Azure cni configuration
# $global:NetworkPolicy = "" # BUG: unused
$global:NetworkPlugin = "azure"
$global:VNetCNIPluginsURL = "https://acs-mirror.azureedge.net/azure-cni/v1.1.3/binaries/azure-vnet-cni-singletenancy-windows-amd64-v1.1.3.zip"
$global:IsDualStackEnabled = $false
$global:IsAzureCNIOverlayEnabled = $false
$global:CiliumDataplaneEnabled = $false
$global:IsIMDSRestrictionEnabled = $false

# Kubelet credential provider
$global:CredentialProviderURL = "https://acs-mirror.azureedge.net/cloud-provider-azure/v1.29.0/binaries/azure-acr-credential-provider-windows-amd64-v1.29.0.tar.gz"

# CSI Proxy settings
$global:EnableCsiProxy = [System.Convert]::ToBoolean("false");
$global:CsiProxyUrl = "";

# Hosts Config Agent settings
$global:EnableHostsConfigAgent = [System.Convert]::ToBoolean("false");

# These scripts are used by cse
$global:CSEScriptsPackageUrl = "";

# The windows nvidia gpu driver related url is used by windows cse
$global:GpuDriverURL = "";

# PauseImage
$global:WindowsPauseImageURL = "mcr.microsoft.com/oss/v2/kubernetes/pause:3.10.1";
$global:AlwaysPullWindowsPauseImage = [System.Convert]::ToBoolean("false");

# Calico
$global:WindowsCalicoPackageURL = "";

## GPU install
$global:ConfigGPUDriverIfNeeded = [System.Convert]::ToBoolean("true");

# GMSA
$global:WindowsGmsaPackageUrl = "";

# TLS Bootstrap Token
$global:TLSBootstrapToken = ""

# Secure TLS Bootstrap settings
$global:EnableSecureTLSBootstrapping = [System.Convert]::ToBoolean("false");
$global:SecureTLSBootstrappingDeadline = "";
$global:SecureTLSBootstrappingAADResource = "";
$global:SecureTLSBootstrappingUserAssignedIdentityID = "";
$global:CustomSecureTLSBootstrappingClientDownloadURL = "";

# uniquely identifies AKS's Entra ID application, see: https://learn.microsoft.com/en-us/azure/aks/kubelogin-authentication#how-to-use-kubelogin-with-aks
# this is used by aks-secure-tls-bootstrap-client.exe when requesting AAD tokens
# TODO(cameissner): remove once 2025-10B image is released
$global:AKSAADServerAppID = "6dae42f8-4368-4678-94ff-3960e28e3630"

# Disable OutBoundNAT in Azure CNI configuration
$global:IsDisableWindowsOutboundNat = [System.Convert]::ToBoolean("false");

# Base64 representation of ZIP archive
$zippedFiles = "UEsDBBQACAAIAAAAAAAAAAAAAAAAAAAAAAAcAAAAd2luZG93cy93aW5kb3dzY3NlaGVscGVyLnBzMdR9a3PbOLLod/8KXFn3xN4JFduJnYmmeO4yEu1orNclKTvZOKWFSUjCMUVoCdCOJ8l/P4UHSZAiaTkz+2FTUxmb7G40Go1+ocHsA2+FKaB+jDcMYAoSigLACAjQAkcI3EKKfZAwHIJFEvkMk4ju7YOBgL1FjKFYg85AAI4AWyFFl4IkClAMKINLHC1f+RS9esBRQB5oZ29vH/QlNgxDgL5iBnwSIEHiWgKBnmvLQdcJZWANmb8C//xsGf+Yf/nln3vtZUhuYdi9Hoz7k2t33nPtuTvr9WzXNY8q39qOM3Hms/HleHI9No/BPjgnMUgi9HWDfIYCgOKYxMCHyXLFwO2jmIsvhr0NiX/HebtLblEcIYaomgpFLNl0NvS4Ycj+5Ho8nFj9+flgaM+vB96HuWN7zifzpAFpML6aXNpz+6Pdm3nW+6Ftvm6AFpTHE29ufxy4nvmmAbT3we5dzq3pYO7azpXtzHuT8djueYOrgffJPG3AnFoz154PRtaFPtZZA8aF7c3d2fux7c2njn0++Gi+bYQe247l2XNvcmmP5+cTZ245I/PXBpSx7V1PnMv5YOzZzrnVs12Ns3c7IFp9a+rZjoZ13KQ9I2tsXdgje+zNB1MdqWn9e9Zw0JsIcQ969tzq9SazsadjNylCbzL2rMHYdvoCYzB2PWs4tPvmcZNClLCc2Xg8GF+Yx02aMZnaY9f9UB6mSSVSlPOBY19bw6HA7U3G54OLmcORm7RjML6yhoP+fGo51sjmqzAYz61/zBxbkTCPm9RlPJn3J71L25l7k/n72WDYVxqazd08btIdrpw9a96zHW9wPuhZnu2ax006k+3jMtZJk8rYo6n3aRulSWHsMd/wc9fucVl4Q9c8adKQi5Frze2PU2vcn1tO78PgyjZPmpRDIshBppNr23E/2MPhfOoMrgZD+8I2T5rURGC7tjd37IuB6zmf5lPbGQ1cdzAZmydN2rKNeWUNZ1wajUaEYw1G04njzXu9C/vKHnuuedJoSYoo1uXVdDqcXQzGKXKjTZl48/PJbNwv7nbzpNGeZEhSE8ez0XvbMV83aUaOM3UmVwMuv8H4Yu72nMHUc83XTSriepbDTUjfnjs2F6nEmnuWe2m+btKWXItdez61epfWhW2+blKXDONy9t52xrZnuzlik6bkQ40HOUaThmQYH8bufDTpz7jfa1IObU8KI5uN0qQeGZLQkwylSSk0qQ34cn38lOPtZjNyg5wivmlSDr6mXm86738aW6NBby502bHGHK9JMaT6KcNYtodvmhRjOuM2IPfx5psmpZDjeNZFEaUx8shF8H4wtpxPabTSpBGpHOyPveGsbxfk0KQYHG/Wr5Zfk26keFXjNVuNeW/mepPRvG95Fp+g+eYd2AcOYknM42JM0wCTBIjHkj5F/jrgsSN4WKEI9Lo31h9JjPqQwZteQhlZ8x87tzgCAUEURITxUJmyJ9hwhU2YDb35cHJhnh79CS5c20E0CVknJMvdmehNpp/42PPeZDjkoeVknFm10ybldWx38A97PnHnfYd7sdNGtzedSTAnjVYsMdK5NeBxy2mjB6zB9QYjezLzzNNGB1iDfDWaC/a5XXdnU645nI9Gj1hDaubIUMq1PfO00TlOZ3P3cjYfjM8nuUMxTxu9Y82geZ5iDYYzxzZPG8MnnYoM5NzBxdjyBGaTTawb3/7Ys6f8J/OsyTI+JTP7o22eNWnZbNq3PO5puT+b94Yz15NpEA85zxpVzlY+dzC9OuMxwVmjktmebvOubEeESGdNuqVmNO85dt8eewNrKIODvu0AE5ydgv08WwYLEgMcUQbDEEdL4McoQBHDMASbmNzjAMU7eSY+VL84lnl2tjVSQB6ikMCgZiiwgDhMYtRkF7YnlYn97dZ4/gr5d3WD+SRa4OUOY1r932euN59aF7ZIkvkONc+aFHs4mVzOpnIlxj1b2nPPujDP3m3xGBIiWEw2ICIB2hASvroaAQaXFNxjCAajvrvLGuSh/vz9ZOK5nmNN573hwB575tujxqWgyE9iBLyhC24JYZTFcAP8EKOI7SCeVN8aGThu0ro/N372ZDAczEZpWs43Z8qZMudvm/al/dFzrJ43/8dgar5t2pJC2CPbs/iimm+bduLUclxbgz3d2wfbUCPr47w36dsAU0Ci8FGW0nAEkggzwBBlFDAC7lGMF4/cw7IVikGEHnQ3HME14gRgEEjklCubw/RIgMZwjejePpiGCFLEB5HVqSSOuZzvYZggQBZNDEIqUDJQ/kuJDxjx0f0YrTlRLIpgTYY0pW2+PdvLmYNBUCZc1ln+egP9O7iUJT9nKuEYIXvVcwcm+PvBHgAAtHQ+VMWv9XL7lbL1stxXD1BXnKvH2KrM1YMWy3L1cI01uXq0yoJcPfhWNa4JtKoUVw/fVId7GmurCFePUlOAaxDtE8W3BsyawtvOGKroVg9fWXB7Grym2Naosc2FtoYlerLI1qxvpbrXDvtwZ4zKwloDeLmo1sD4dkHtKeD6YtoTmDWFtOdgySLaExjlAtrO4OXiWZOuVBbOdkHQi2a7wFcVzOrxmoplu2hkXijbAXq7SLYDklYg2wE6L47tAFwsjO2AoBfFdgDfKojtgrNVDGtYvNpCWD1OUxGsHqtcAHuKfqn4tZNf0AtfT895uwjVjFNd8Hoa5znjbBe6mmEL1agmGdXWjOqRSvWiBpvWWCt6Pp6qEz0fsbJG9HwyWn2oGXm7NvT8wcp1oR0plGpCO2JV1YOej6rVguqRm+pADUOWakDNkNv1n3r4htrPLja1oozTsN1qSzH1OFWllHroujLKDlNpKEY8Lb2fQs6ePFGGqKeglSCaZKKVHxocUaH00No75Nm1t0JpzgwCsoY4AoyAW1EMCLKseSoh+irZPv9XEAETtKMkDFMaMVqgOEZBRu38//fHOYH0dTWlVpq2d+Ad7cA/khh1fLJu7e2DcxiGt9C/E/QAXmgj+TCKCOPM+iRi0GcaxylazXjQp8YaxzGJ5WgoWKJOhFiLy2Q88ewuuMyacq5QTDHRjkvEcDgCrftWNuAIR3gNwy2sa8xWQ8gQZT2JheKAc3DcOfm1c9QC++AahyHwVzBaIoAZF78owpA4Rj4D92pwcYzygABNNhsSM1HsSHua/JyyAlersuZMJWutwSijx4io92ioJ52vPzWbEzmd1687R3zBrJCtSLJcqVlEDENBPtWLJA4BpoAiBnAErEs3q9NE5OGlmCLjEomQ7B5LNgFksjC1IGFIHnC0BPcwxvA2RFQUgawlith7eIfiTCT2iS3rZHpX2LacAEPrTQhZXkzM56VUx1MQfJb3345+GFI9j1/d4gjGGNFXOVlDBzBUM5cB18HZmw6DcWf5h1CwVKGiZH2LYlXiM7IiH58cSSjYhNBHNOPMZXzGOX8pFSH9s87r01wZy0tUAH3bOTmqBz3RYE86R503rb28VicnpCBOjk5OBdTRyamY1nkShtkybyBbUQBjBJYoQjFkKAAJ5Wv3mbIYR8sv3e45ideQHTwp+pegrdbrUO4DrhsoyBmz71HE6JAslzha9nHM2ep1bxS/4uTxZkiW9GYaJksc0ZsR9mNCyYJ1emS9SRjqyKNRVzQZ2l8ZivhwN5LwTS4uD9K7MVwLbSg+9fAauQyuN/LVnmqHXOCQoRjEaE3uuflI5GaPubmKKTi4OeJzwv5KyMqHG5bEUg0iStcd9BUBkrBNwuTMQ7Jc8n2xisUe25AHFNMVCsM9NZAjBhonYUjBN9CeAyNGQpHAi5ujFy/Bixfgx14KzHmmgudvoNU+uEDM6HNVN+TKAHLYBe15S2CofkxwHWOGjCFZHrTXiFK4RIfgm/A57TVdcregHoPvOX3xXmJ+IJQJ0D2d6gjGd1sE8QIcGEJiBvoXyDWWMg7OiYMUVIxfBWCCdFYZXDYD0OJg3ZzjAxxhcSK0hvHdYUtg/AAopEgfRtXH68i3UQg3fCub4KAAa1RyeNjxCIPhCIchpsgnUUB34TQbZU0BxZGPQAhFQ2vGeINIdLbkJAuLkXlLHKLJPYo/MLZRApjCGK4PMvqfxe+IofhgBKMAMhI/cvosTtDhl3Sn5+zM4vDlTyP3EWU4gpzFKWSrnQnhiGlU7K+Y9Ugg5324J/63D85xTJk8HOROhyLEtQ/y7YvAA2bSnVG+87NzlTBGMHgEPvRXKABEtilffejLzeCHCEazOOSMzOKw425CzA5e/L8Xh5+PJDttTlwZk8+DSYdP6ku3e4HYuXpxkFFRjLYpgrG/EucWh9keyQwo54SbPwNGATjwEGUGJwrKAIeFbZPR5Ez0MQ87SPyYc0K3BniZ8/5SYLmCxGTD1+ZLt2uFYUoHI3qoVCznV47Y6ZEkYsCIEDjSGdK0fiY8hpJw6rPJQhOdAXpk88ihxFItYrIG7XSEz0dfDvlyllUn3yAc2RgwtAZKUhkiMDSkLQrCRPrp5uF/l62EPMGcxoQRn4RUWzLxGkdVAJ/dR8rQujNGrOPy95g9phDe4wZ96XYlRB8tYBKyl2AXDBq+VvrD/yxIjKC/AgftjYLj3ialY0fJWi79FQwTRJ9mqaBMIF3i7fkZEWEqVKIgG7uMXCm7X8wcoQD9Y2/7pyLD8T320ZTgiI1gBJco5gIpTYNv0dKQubjaI7jZoEDu5JkIRo33kCL+wBhIf8F/5pu8UoUFSgBmzlDAAOO/dZqMZGeYmlZX6mzOEgmDaUyWMaJUZlaIOwATtLef5kiVGC9cHKKIhY88+MJRgl5ow6SMcTfBY6pUsn0MlxGhDPu04zKyeYDM55bLZTBmY/Sg6TmLH0sL3IbxUij7t1mMzVwSv4ERYisSmK0LxFq/gUkijI9ZlsNvQJzhWsJVmS0+futHYQQHsfjR6JH1mpvB7IfWILond8hwEGVyqBYwLM6MZMngeBhRcCp/fOyjED660iWD46Nc1dT9jeK8XMSM1LeA/Ke29ozzPVIOvHUOcSgDPf0MO5dHR85TBGAVWl5cHLEMunlR0cGIS7oEaqtXesCRIeruxNpsBhHFyxWjPdl5wU21yPrLu7aNeKAMTDBGD8bk9n945trKg2xrswmxL5YwpdjpQwa50vFImHZEoO2hEK255FsVxDtp2M21Io1QKgGnMdmgmGFEP7dST9r6wgWR7q8qrBFffZ9+bvWTWHA6ohIpE2URq05IHS+G/p2Yz4Ekfagt3xPbsXpn71XZlVQEKJCer2hTtvwVjnSlWNNccjyAFR5w28dpOw2kBgJ8BzI7MIaYMvCdb1TDFbEa+J4zuAe2wkp9h+ztHE6azWFccxRo1gaT+mYUT+UqaQJ2EQPZ5uUizX7h1gR9xSzfojo1KdksNVVIZjHw3AcPsuHme9pCQ9EGxpxp/gCCBxLfwZgkUaDC+xYgMXgBAiJKUPw1B8yumW1QLMgwsYZLWmRCY888KHCr54ffeX74f9/2XkhZiOasnG19KaeEsg2JpDGFMVNZdKyWlefahkcMsQuAkSXNLevS7aisvOfanZRMiUpLomSmUvgVvgR+jHh6CiPAx2Y8mWGQiog9liRkDD5SawAlt9IsuTyITEIUcNpKqQ37K/IThkArz6R5zi09QyI6llq5C/lnS3FqpKyqOPCfLTXiJsaRjzcwrBp0mr00ZhTFgwC4n1zPHgGucCTi0RRQEYvl+zI4dpJoiO5RCD7g5QpRprSHxXi5FEuOqZQBSZ19O30nOfid3HrqgWExALIs/7BjBYFybwfHp4fcIiOZqE4yWuI2Jq6TIjCUHFNJG/kUNVEYKQMZazy2FqUWjpQKFfipUOGC/y3aMnnEz02Lvq4OWmLKUFxmJtczpQ2Gn2vUINokTLkmbVrlXd8TKhbspGP6jpB4RpY+/YSB27JR50kYPp3pmu0FDGl1xpxyMxMbyQQtWYwLwSaJN4QqW3WYp2bGmLBC5pjycFiTocl5gyAdKccQpdkSC7nX4bok8y7+t1D9DBSUxgb/rc4aQFU9RveJu3EhrxooFyh81D5YMbah3VevKIP+HblH8SIkDx2frF/BV6/fnJ6+Oz198+rs3dvjk7N80fkkPLTekBjGj/ngqhy2gbEMitK4uZDjczz+m4ra0sUD7UhVBBTSRYKDL93uGD3wnxT0DtI7+J3gSAlScSJIHxbU1rp0DfvrBkaBYcX+Ct+jnyr0XMEQ8zRnTNg4CcNJbK837PEg18n203r8LHLPrgWle6Se9C0hIYLRl3ae2cuNUcxhStJSEpbxUjmAan8rPflRjKl41K5XEkrq7Ca+jyhdJGH4yD09jPJoT9CvLW1spygaWZV5MKJo6hSNqqwjixCrA0KJ+YywEDSkS7t0Y5dTqVkEb0MkJyTyCfAH3ohZbSVRxYi0mCn+WxQ/N8ZqmKdV9UnSK0hX4jBIo84T2b+AdDHIVhnxv4VuIb3W3RA32AdtDExw9Bv4rVDh364m7IO+DIhDsgQimZfRsvhxDR+zs1qKIooZ37EBZLBAQ9sagjHQxqAL2r5cr2KKGcsrb/+VLSf4Ox8qg8kT9KoaQRv/8kvhgSyVAWOJMmFXFcTYKiYPoD0vvCgWPUSMbLghQps6+eZIxV2g6iIyFBY7aeed0JBfZdSeil4KFD5/Keo0NyY7EngyP8QRK5IPQ/KAghRSVmCPDosY27uBK2YjTLFwZILjWu3mSx/mS/+bUJCaQIvDAieJRDSsiTcTE+h0Ormy/lclTPZaKN7Qcj3748ATNzmMiDAcbUulrI86S9oIcmOgACQR1d2WODvJr/kUxmzVarCRSq9BlfkfX/mgiv1XihLBDqzrjFdt+61dJP733MKf/XUFE8pzjFgplAhRK1armGFYlKKYGec4RLaIX3ffpk2napwejwt3NvJPH6dVJxJqnEIi8VzZZVRK14arnDuPWlSt4X2Cw2Asui3U4MqOH6ShjaoZPoLWh8vhqHvjTs69a8ux806BtJsAjL2bnjw+VY0QrcOOeiDGqWMibaxQ2cGtxpNZw6yApA+YieMaDUOXYev47duz1y3wLZ1U6/jXo3ctbSu0To5ev/lVhwgZ9U+OTk6KUKev3xWgTl5/KEB8a8+FqxKQ71rymJE/CxFovT56/e5t60eO3tA1kpNU51g71tJrg8Pqnv+akjsjYIGjQKTxqkcHCNmqhpxuYXHKxfdaJZvChKL/vEWugnreQlfT+E9f2YG8jGrkXUni2C8wJpGR98UZ+oJrlvgZVridj5C1RzwLfTx4j6M+jn8KtUeixU/hchn8NGKhqXBPOY59vkEKN1BTk6tO/l/Kcif/L2IoxmsV7D8g0Ty1UQcn+B6Fj2mjpOgf0Jscj4S7hWFYpt4RLyLyIPvxGKKMG6s9ANoPRQtuVpj1vUJ4oZQHaD2fIhDSltoZdstLv91z2q0Q10tQHLlb5o/r9a4VeMVozofQ8Um0NWptTR6Xp9oHt5wGIFFF32kHFKbcBdvNf7WSUJD81XvVe1kWCaiXiVCw6uHSflTRPOJMcxZVMb6zyU4UOyT2V4gycVIzjYkoMuTM9sQHBDIB66stxudhMIzALRK/GQACHmyCmTPsANRZdl4C0EorkdU90Vq3afrhw1f3R52jzpuz6o5U+a6mGVVxEQEUBRuCI9ZVbPwEF0rE10juHy5QbeOlfaENuiE7HKtXCPFkQGyh1qsWoERrhe7KlQXHHaDCMHCLVvAek1i2ckmbkgpaQZ90uC8qm4eUS9EGv1yG8pI5NwVpxRyQGKwIW+CvfLptv9xjaz7RrrubnYjRvxI+6MwZgiYzkYqu0U5oQMVN0RFLJlLBwggdOwroNWarg9arVhav72f28UEt8SZG9xg9VNnXdGhlQdUoJTuqd3VuR4mFHrV6Odc1MEuXLtJAPvbBZyWFL9uSOhRdwDBGHtHAfqIV/lBETUc/yXmB8b0SsmqJBubP9U9vcXFYEXtwj1188EsFC3u6WLd8425rug+8SX8CDm4RDhFeJTBaHoKu6pJWH5Ti+TteqK+kCtPgTLmljpH8IoS2t0uXJWRGnaleYQqMoVg0t9/fBL/cdNK/ZNO++LHajNZBFw3rDbesN8q0Vm0tYMhPzm7zVFAaAYQCkTmb6a80bRwtTerkT+rGExtJ6ypq1paOIzsJDnT2X1ZxepjpuKih7GQQKQnvUVAy1vBO3ij5t9rIPxFNPSNq2o6MCr9zNrZTEmAUl6SsbFluoKUJ4qkK+/UUABgqpM9i+0I+VJTBX1J6SuW4c+mpksJ2E49suxJtE2ZrEC3EVsAkgqG2LUv9OdttyAUqIt1Mq0zaIDRtMDM/p+0Tk8WCIval250xf0weOh6ZRfgrf6O33KmDXL0T36y4gdF6fHx8NEYjIwjAhw/d9bpLaWexWLTShvAQUla8lFJ4nDazARMcbc29eG2FC6DVKkigRLx8CWYbUBuufSBOx/Ea0Q2MgCFVv2ZoOwoKoii0jJeH5cQLLFQTLV1zEJB6BbhM1Siok5KjvntNcID8FSk+/M637T2KmUeM32nmV9U9Df4EmODvkppWzvlAKBN9iV3QaqPovpt2qkT8Yb4hWkNtCQSwviZVgOkSFICzhxqCCpb1OXe3d9SPvdbfq6akRKE/3BaFRPwfSiJ1ElwliuySkOC4ail1ricbJKcyCHR4/bEGnWZ/XdA67hwf6a8KQi3pgg5nZ1ZArlX+qwakCVCTSFGAUvcm8jKXLpTvoirGLbdo0viWWqbSpbYf7W9Fk/Ojw4nI9hXr0gUPOAwBi6E46MyveFZncGnbYaDKdPklYNWMXndFdm+fZ2+/JxECx8fcv/M4qwPA7wlPkmKVdYlWxJyVBwQeYCQ83wreI7BIb/WGZIl9nm7JHkRG9vYBimgS8ygQMnHht5p/LMv/4i6DODV5QCK3zkgrLkgYgF5/LFK//exWXurVKGJSDlLo2cXSzKZUXSBWlPObyOKus/hXBcQa8IBuvWHpAmzDgoW4biS+jLaQE11AHFKAFYWmSWjdCyImMhSLtMDjX+Kgs2vbnOTPe+n0MvZuVNJOnbrD19OfJXENMRPHizVHs+1Nca3TWx5mSRDlg9zjHQ5y94EoDcVrudpKV7nduw0xXfGwNkI+w/eYPfJFr1H6W7QgMRJfhSy2R4rGxPxstOLaRYzohkSUuzF14H+Nbh1VZzBmMc5rPu1vhfn+eJXbglcrBEO2+qMlWljfQ4r9KYzFLS3h60nCXOSD01KfU+mSSTVnIgwz5Yl69rDjMsgSKo4YC2gikCmg8tTz5OioqoFC8/t2KnOZTBSkXlznTku1MY3T3kP9z22M4F3hqXYZqbr7ozTRo8JbncWvPpKtsQ8rHHJDKi64MdKgMCXWQUZD3uCtmYgQ4ryTAXccxWLltazKharC1hdNp6Bf19or8IBl4aCmB2YfDBZqz4gj32dum5cFe6rbUn2Qhu2vG7ACTlEJtlpTQW1bQ9kWaYIB25Fvzfc3qhmWqLumrMqJ5B/mWEO8VeyfloMD7sS6Tey1ZFhSdLbCtdEHuJGRh/zciPrnfWbOMK8Ni0+KohgvsPZBkcLguRcsXcn7S/xefq2v4B/kpyjS2ocGJF5zPf4/B9rjtNajfW3kJo+lbngw9T1V2Buusertjfj2yWHRfVyjF/KI6xbeho8i9MERmCa3IfaBH5IkyIDT8/ecXV2n9ASwSq/EPizf8UrH54GaNuRLcJsIZ8aDuugFywpylWsGHlHegCSGAGZzEGMUjFqub01fkzH0zZqhNHwPRhfOPlA1rFQ7CyqZHktWa2Qq3CelW/e1m0N1b7ugQiG+Q7lnrgvKX/2tqC+1qppf96n/Bs7Lpo0tpZWX1Z+cbO0wO0y35vDpJyZbI/IdpioVo2JPFRuJpRaLoAeoG1YO8kkcmPKXz0dfDuWdEP1lqWv6b1ozuA7W4RFben9yQcD3ApKEzmIGs4iavdjb6j7MXsl49SVnvEAmc+yDKEJx9uuhKHJ844lvG7fA38CvWSijEfheN7Mfez/2/jcAAP//UEsHCGTSR482HQAALW4AAFBLAwQUAAgACAAAAAAAAAAAAAAAAAAAAAAAFAAAAHdpbmRvd3Mvc2VuZGxvZ3MucHMxrFNPT9tOEL3vp5jfkkMi/ezYQUSF1i00pWCVPxGGSi3lsI0n9or1rrU7dlshvnu1NiFQQOqhe/LMvHkzb2b8ZoMBAITZl5PTeZZmneXfRa2MyB0IUKaA743OFQIZoBKhNI5gaSxYJCuxFQpaKeCgQUefj49M4ULW037Yz2Zn6fw8PT35t8z+nYtr9DS1sKJCQgtmCQK+pnNYSoWgRdURN13B/+FHKRclSAcONa0qHhpHewVquqf1BX1k3FZd4MgUgDqvjdQUso237HJW5QrpvdS51MVwdMW6DoYdw6UjK3Vx1RmDuaCSjRiTSxj+NzxHR4F39YHRCG46mEVqrGa3jA0OjFAZCcI9WzhIYLdH8GOk0uQ84QdI/HXvu7CSJ7wkqnfG43j6KpxuhvFkO4yn40osSqlx/G5hqjopjFDOk64yD1HkaB1Pdm/4z6ByQYvWSaN5widRPAniONiM+C27fdAQJDAYpro11xicoaO+I9h91PEovDcZG/SbfknJvPkLJTubk63J9MEqVimp/igV8qSb5FNZ99t8Rt9WEG0HUXzHtAYtlERNwcJYi0qQNFr6Pl/C+fPiCd/7lM2y/blqCqlfgq7LR2EcRk9hRpOQGq0vuB55OFv5119p/mdyWwk/G2WKIMdamV8VavJEw2eZzozCVDsSeoFH0tEjh8ctZdHYTv6ddeL/o8DVShLwbyEfXUb9efsDeeYi1mv/HQAA//9QSwcIhV/jUSECAABeBAAAUEsBAhQAFAAIAAgAAAAAAGTSR482HQAALW4AABwAAAAAAAAAAAAAAAAAAAAAAHdpbmRvd3Mvd2luZG93c2NzZWhlbHBlci5wczFQSwECFAAUAAgACAAAAAAAhV/jUSECAABeBAAAFAAAAAAAAAAAAAAAAACAHQAAd2luZG93cy9zZW5kbG9ncy5wczFQSwUGAAAAAAIAAgCMAAAA4x8AAAAA"

$global:KubeClusterConfigPath = "c:\k\kubeclusterconfig.json"
$fipsEnabled = [System.Convert]::ToBoolean("false")

# HNS remediator
$global:HNSRemediatorIntervalInMinutes = [System.Convert]::ToUInt32("0");

# Log generator
$global:LogGeneratorIntervalInMinutes = [System.Convert]::ToUInt32("0");

$global:EnableIncreaseDynamicPortRange = $false

$global:RebootNeeded = $false

$global:IsSkipCleanupNetwork = [System.Convert]::ToBoolean("false");
$PreProvisionOnly = [System.Convert]::ToBoolean("false");

$global:EnableKubeletServingCertificateRotation = [System.Convert]::ToBoolean("false")

# Windows Cilium Networking (WCN) Platform configuration
$global:EnableWindowsCiliumNetworking = [System.Convert]::ToBoolean("true");
$global:WindowsCiliumNetworkingConfiguration = "";
$global:WindowsCiliumNetworkingPath = Join-Path -Path $global:cacheDir -ChildPath 'wcn'
$global:WindowsCiliumInstallPath = Join-Path -Path $global:WindowsCiliumNetworkingPath -ChildPath 'install'

# Extract cse helper script from ZIP
[io.file]::WriteAllBytes("scripts.zip", [System.Convert]::FromBase64String($zippedFiles))
try {
    Expand-Archive scripts.zip -DestinationPath "C:\\AzureData\\" -Force -ErrorAction Stop
} catch {
    $global:ErrorMessage = ("Failed to extract inline scripts.zip: $($_.Exception.Message)" -replace '\|', '%7C' )
    $global:ExitCode = 73
    exit 73
}

# Dot-source windowscsehelper.ps1 with functions that are called in this script
. c:\AzureData\windows\windowscsehelper.ps1
# util functions only can be used after this line, for example, Write-Log

$global:OperationId = New-Guid

if (-not (Test-Path "C:\AzureData\windows\azurecnifunc.ps1")) {
    # Determine the CSE package URL
    $WindowsCSEScriptsPackage = "aks-windows-cse-scripts-current.zip"
    # CSEScriptsPackage is cached on VHD. Previously the cse package version was managed in components.json, whereas RP set the package URL which is a storage account.
    # From 2025-06 The CSE packages is eleased on the VHD. RP can use fully qualified URL to download CSE scripts package when required out of VHD release cycle.
    # In the transition period, it is important that when deal with older VHD versions, the agentbaker runtime provision script needs to be compatible with the latest known storage account package, 0.0.52.
    Write-Log "Requested CSEScriptsPackageUrl is $global:CSEScriptsPackageUrl"
    if ($global:CSEScriptsPackageUrl.EndsWith("/")) {
        $search = @()
        if ($global:CacheDir -and (Test-Path $global:CacheDir)) {
            $search = [IO.Directory]::GetFiles($global:CacheDir, $WindowsCSEScriptsPackage, [IO.SearchOption]::AllDirectories)
            # list files in the cache directory.
            Write-Log "the directory $global:CacheDir contains the following files:"
            Get-ChildItem -Path $global:CacheDir | ForEach-Object { Write-Log "  $_" }
        }

        if ($search.Count -eq 0) {
            Write-Log "Could not find windows cse package on VHD. Use remote version instead."
            $WindowsCSEScriptsPackage = "aks-windows-cse-scripts-v0.0.52.zip"
        }
        Write-Log "WindowsCSEScriptsPackage is $WindowsCSEScriptsPackage"
        $global:CSEScriptsPackageUrl = $global:CSEScriptsPackageUrl + $WindowsCSEScriptsPackage
    }
    Write-Log "CSEScriptsPackageUrl used for provision is $global:CSEScriptsPackageUrl"

    # Download CSE function scripts
    Logs-To-Event -TaskName "AKS.WindowsCSE.DownloadAndExpandCSEScriptPackageUrl" -TaskMessage "Start to get CSE scripts. CSEScriptsPackageUrl: $global:CSEScriptsPackageUrl"
    $tempfile = 'c:\csescripts.zip'
    DownloadFileOverHttp -Url $global:CSEScriptsPackageUrl -DestinationPath $tempfile -ExitCode $global:WINDOWS_CSE_ERROR_DOWNLOAD_CSE_PACKAGE
    AKS-Expand-Archive -Path $tempfile -DestinationPath "C:\\AzureData\\windows"
    Remove-Item -Path $tempfile -Force
} else {
    Write-Log "CSE scripts already exist, skipping download"
}

Mark "Start"

# Dot-source cse scripts with functions that are called in this script
. c:\AzureData\windows\azurecnifunc.ps1
. c:\AzureData\windows\calicofunc.ps1
. c:\AzureData\windows\configfunc.ps1
. c:\AzureData\windows\containerdfunc.ps1
. c:\AzureData\windows\kubeletfunc.ps1
. c:\AzureData\windows\kubernetesfunc.ps1
. c:\AzureData\windows\nvidiagpudriverfunc.ps1
. c:\AzureData\windows\securetlsbootstrapfunc.ps1

if (Test-Path -Path 'c:\AzureData\windows\windowsciliumnetworkingfunc.ps1') {
    . c:\AzureData\windows\windowsciliumnetworkingfunc.ps1
} else {
    Write-Log "Windows Cilium Networking function script not found, skipping dot-source"
}

Mark "Functions Sourced"

# ====== BASE PREP: BASE IMAGE PREPARATION ======
# All operations that prepare the base VHD image
function BasePrep {
    Write-Log "Starting BasePrep - Base image preparation"
    Logs-To-Event -TaskName "AKS.WindowsCSE.BasePrep" -TaskMessage "Starting BasePrep - Base image preparation"

    # This involves using proxy, log the config before fetching packages
    Write-Log "private egress proxy address is '$global:PrivateEgressProxyAddress'"
    # TODO update to use proxy

    # Install OpenSSH if SSH enabled
    $sshEnabled = [System.Convert]::ToBoolean("true")
    if ( $sshEnabled ) {
        Install-OpenSSH -SSHKeys $SSHKeys
        Mark "Open SSH Installed"
    }

    Set-TelemetrySetting -WindowsTelemetryGUID $global:WindowsTelemetryGUID
    Mark "Telemetry Set"

    Resize-OSDrive
    Mark "OS Drive Resized"

    Initialize-DataDisks
    Mark "Data Disks Initialized"

    Initialize-DataDirectories
    Mark "Data Directories Initialized"

    Logs-To-Event -TaskName "AKS.WindowsCSE.GetProvisioningAndLogCollectionScripts" -TaskMessage "Start to get provisioning scripts and log collection scripts"
    Create-Directory -FullPath "c:\k"
    Write-Log "Remove `"NT AUTHORITY\Authenticated Users`" write permissions on files in c:\k"
    icacls.exe "c:\k" /inheritance:r
    icacls.exe "c:\k" /grant:r SYSTEM:`(OI`)`(CI`)`(F`)
    icacls.exe "c:\k" /grant:r BUILTIN\Administrators:`(OI`)`(CI`)`(F`)
    icacls.exe "c:\k" /grant:r BUILTIN\Users:`(OI`)`(CI`)`(RX`)
    Write-Log "c:\k permissions: "
    icacls.exe "c:\k"
    Mark "icals"
    Get-ProvisioningScripts
    Mark "Provisioning Scripts Retrieved"
    Get-LogCollectionScripts
    Mark "Log Collection Scripts Retrieved"

    # NOTE: this function MUST be called before Write-KubeClusterConfig since it has the potential
    # to mutate both kubelet config args and kubelet node labels.
    Configure-KubeletServingCertificateRotation
    Mark "Kubelet Serving Certificate Rotation Configured"

    Write-KubeClusterConfig -MasterIP $MasterIP -KubeDnsServiceIp $KubeDnsServiceIp
    Mark "Write-KubeClusterConfig"

    # to ensure we don't introduce any incompatibility between base CSE + CSE package versions
    if (Get-Command -Name Install-SecureTLSBootstrapClient -ErrorAction SilentlyContinue) {
        Install-SecureTLSBootstrapClient -KubeDir $global:KubeDir -CustomSecureTLSBootstrapClientDownloadUrl $global:CustomSecureTLSBootstrappingClientDownloadURL
        Mark "Secure TLS Bootstrap Client Installed"
    } else {
        Write-Log "Install-SecureTLSBootstrapClient is not a recognized function, will skip installation of the secure TLS bootstrap client"
    }

    Install-CredentialProvider -KubeDir $global:KubeDir -CustomCloudContainerRegistryDNSSuffix ""
    Mark "Credential Provider Installed"

    Get-KubePackage -KubeBinariesSASURL $global:KubeBinariesPackageSASURL
    Mark "Kube Package Retrieved"

    $cniBinPath = $global:AzureCNIBinDir
    $cniConfigPath = $global:AzureCNIConfDir
    if ($global:NetworkPlugin -eq "kubenet") {
        $cniBinPath = $global:CNIPath
        $cniConfigPath = $global:CNIConfigPath
    }

    Install-Containerd-Based-On-Kubernetes-Version -ContainerdUrl $global:ContainerdUrl -CNIBinDir $cniBinPath -CNIConfDir $cniConfigPath -KubeDir $global:KubeDir -KubernetesVersion $global:KubeBinariesVersion
    Mark "Containerd Installed"

    Retag-ImagesForAzureChinaCloud -TargetEnvironment $TargetEnvironment
    Mark "Images Retagged for Azure China Cloud"

    # For AKSClustomCloud, TargetEnvironment must be set to AzureStackCloud
    Write-AzureConfig `
        -KubeDir $global:KubeDir `
        -AADClientId $AADClientId `
        -AADClientSecret $([System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String($AADClientSecret))) `
        -TenantId $global:TenantId `
        -SubscriptionId $global:SubscriptionId `
        -ResourceGroup $global:ResourceGroup `
        -Location $Location `
        -VmType $global:VmType `
        -SubnetName $global:SubnetName `
        -SecurityGroupName $global:SecurityGroupName `
        -VNetName $global:VNetName `
        -RouteTableName $global:RouteTableName `
        -PrimaryAvailabilitySetName $global:PrimaryAvailabilitySetName `
        -PrimaryScaleSetName $global:PrimaryScaleSetName `
        -UseManagedIdentityExtension $global:UseManagedIdentityExtension `
        -UserAssignedClientID $UserAssignedClientID `
        -UseInstanceMetadata $global:UseInstanceMetadata `
        -LoadBalancerSku $global:LoadBalancerSku `
        -ExcludeMasterFromStandardLB $global:ExcludeMasterFromStandardLB `
        -TargetEnvironment $TargetEnvironment
    Mark "Azure Config Written"

    # we borrow the logic of AzureStackCloud to achieve AKSCustomCloud.
    # In case of AKSCustomCloud, customer cloud env will be loaded from azurestackcloud.json
    

    Write-CACert -CACertificate $global:CACertificate `
        -KubeDir $global:KubeDir
    Mark "CA Certificate Written"

    if ($global:EnableCsiProxy) {
        New-CsiProxyService -CsiProxyPackageUrl $global:CsiProxyUrl -KubeDir $global:KubeDir
        Mark "CSI Proxy Service Created"
    }

    if ($global:TLSBootstrapToken) {
        Write-BootstrapKubeConfig -CACertificate $global:CACertificate `
            -KubeDir $global:KubeDir `
            -MasterFQDNPrefix $MasterFQDNPrefix `
            -MasterIP $MasterIP `
            -TLSBootstrapToken $global:TLSBootstrapToken
        Mark "Bootstrap KubeConfig Written"
    }
    if ($global:TLSBootstrapToken -or $global:EnableSecureTLSBootstrapping) {
        # NOTE: we need kubeconfig to setup calico even if vanilla/secure TLS bootstrapping is enabled
        # This kubeconfig will deleted after calico installation.
        Write-Log "Write temporary kube config"
    } else {
        Write-Log "Write kube config"
    }

    Write-KubeConfig -CACertificate $global:CACertificate `
        -KubeDir $global:KubeDir `
        -MasterFQDNPrefix $MasterFQDNPrefix `
        -MasterIP $MasterIP `
        -AgentKey $AgentKey `
        -AgentCertificate $global:AgentCertificate
    Mark "KubeConfig Written"

    if ($global:EnableHostsConfigAgent) {
        New-HostsConfigService
        Mark "Hosts Config Service Created"
    }

    Set-Explorer
    Mark "Explorer Settings Configured"
    Adjust-PageFileSize
    Mark "Page File Size Adjusted"
    Logs-To-Event -TaskName "AKS.WindowsCSE.PreprovisionExtension" -TaskMessage "Start preProvisioning script"
    
    Mark "Preprovision Extension Completed"
    Update-ServiceFailureActions
    Mark "Service Failure Actions Updated"
    Adjust-DynamicPortRange
    Mark "Dynamic Port Range Adjusted"
    Register-LogsCleanupScriptTask
    Mark "Logs Cleanup Script Task Registered"
    Register-NodeResetScriptTask
    Mark "Node Reset Script Task Registered"

    Update-DefenderPreferences
    Mark "Defender Preferences Updated"

    $windowsVersion = Get-WindowsVersion
    if ($windowsVersion -ne "1809") {
        Logs-To-Event -TaskName "AKS.WindowsCSE.EnableSecureTLS" -TaskMessage "Skip secure TLS protocols for Windows version: $windowsVersion"
    } else {
        Logs-To-Event -TaskName "AKS.WindowsCSE.EnableSecureTLS" -TaskMessage "Start to enable secure TLS protocols"
        try {
            . C:\k\windowssecuretls.ps1
            Enable-SecureTls
            Mark "Secure TLS Enabled"
        }
        catch {
            Set-ExitCode -ExitCode $global:WINDOWS_CSE_ERROR_ENABLE_SECURE_TLS -ErrorMessage $_
        }
    }

    Enable-FIPSMode -FipsEnabled $fipsEnabled
    Mark "FIPS Mode Configured"
    if ($global:WindowsGmsaPackageUrl) {
        Install-GmsaPlugin -GmsaPackageUrl $global:WindowsGmsaPackageUrl
        Mark "GMSA Plugin Installed"
    }

    Write-Log "BasePrep completed successfully"
    Logs-To-Event -TaskName "AKS.WindowsCSE.BasePrep" -TaskMessage "BasePrep completed successfully"
}

# ====== NODE PREP: CLUSTER INTEGRATION ======
# All operations that should only run when connecting to the actual cluster
function NodePrep {
    Install-KubernetesServices -KubeDir $global:KubeDir
    Mark "Kubernetes Services Installed"

    Write-Log "Starting NodePrep - Cluster integration"
    Logs-To-Event -TaskName "AKS.WindowsCSE.NodePrep" -TaskMessage "Starting NodePrep - Cluster integration"

    Check-APIServerConnectivity -MasterIP $MasterIP
    Mark "API Server Connectivity Checked"

    Write-Log "Configuring networking with NetworkPlugin:$global:NetworkPlugin"

    # Configure network policy.
    Get-HnsPsm1 -HNSModule $global:HNSModule
    Mark "HNS Module Retrieved"
    Import-Module $global:HNSModule
    Mark "HNS Module Imported"

    Install-VnetPlugins -AzureCNIConfDir $global:AzureCNIConfDir `
        -AzureCNIBinDir $global:AzureCNIBinDir `
        -VNetCNIPluginsURL $global:VNetCNIPluginsURL
    Mark "VNet Plugins Installed"

    Set-AzureCNIConfig -AzureCNIConfDir $global:AzureCNIConfDir `
        -KubeDnsSearchPath $global:KubeDnsSearchPath `
        -KubeClusterCIDR $global:KubeClusterCIDR `
        -KubeServiceCIDR $global:KubeServiceCIDR `
        -VNetCIDR $global:VNetCIDR `
        -IsDualStackEnabled $global:IsDualStackEnabled `
        -IsAzureCNIOverlayEnabled $global:IsAzureCNIOverlayEnabled
    Mark "Azure CNI Configured"

    if ($TargetEnvironment -ieq "AzureStackCloud") {
        GenerateAzureStackCNIConfig `
            -TenantId $global:TenantId `
            -SubscriptionId $global:SubscriptionId `
            -ResourceGroup $global:ResourceGroup `
            -AADClientId $AADClientId `
            -KubeDir $global:KubeDir `
            -AADClientSecret $([System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String($AADClientSecret))) `
            -NetworkAPIVersion $NetworkAPIVersion `
            -AzureEnvironmentFilePath $([io.path]::Combine($global:KubeDir, "azurestackcloud.json")) `
            -IdentitySystem "azure_ad"
        Mark "Azure Stack CNI Config Generated"
    }

    New-ExternalHnsNetwork -IsDualStackEnabled $global:IsDualStackEnabled
    Mark "External HNS Network Created"

    # Turn off Firewall to enable pods to talk to service endpoints. (Kubelet should eventually do this)
    netsh advfirewall set allprofiles state off
    Mark "Firewall Disabled"

    # To ensure we don't introduce any incompatibility between base CSE + CSE package versions
    if (Get-Command -Name Enable-WindowsCiliumNetworking -ErrorAction SilentlyContinue) {
        if ($global:EnableWindowsCiliumNetworking) {
            Enable-WindowsCiliumNetworking
            Mark "Windows Cilium Networking Enabled"
        } else {
            Write-Log "Windows Cilium Networking is not enabled, will skip Windows Cilium Networking installation"
        }
    } else {
        Write-Log "Enable-WindowsCiliumNetworking is not a recognized function, will skip Windows Cilium Networking installation"
    }

    if ($global:WindowsCalicoPackageURL) {
        Start-InstallCalico -RootDir "c:\" -KubeServiceCIDR $global:KubeServiceCIDR -KubeDnsServiceIp $KubeDnsServiceIp
        Mark "Calico Installed"
    }
    if ($global:TLSBootstrapToken -or $global:EnableSecureTLSBootstrapping) {
        Write-Log "Removing temporary kube config"
        $kubeConfigFile = [io.path]::Combine($KubeDir, "config")
        Remove-Item $kubeConfigFile
        Mark "Temporary Kube Config Removed"
    }

    Start-InstallGPUDriver -EnableInstall $global:ConfigGPUDriverIfNeeded -GpuDriverURL $global:GpuDriverURL
    Mark "GPU Driver Installation Attempted"

    if (Test-Path $CacheDir)
    {
        Write-Log "Removing aks cache directory"
        Remove-Item $CacheDir -Recurse -Force
        Mark "Aks Cache Directory Removed"
    }

    Enable-GuestVMLogs -IntervalInMinutes $global:LogGeneratorIntervalInMinutes
    Mark "Guest VM Logs Enabled"

    if ($global:RebootNeeded) {
        Logs-To-Event -TaskName "AKS.WindowsCSE.RestartComputer" -TaskMessage "Setup Complete, calling Postpone-RestartComputer with reboot"
        Postpone-RestartComputer
        Mark "Reboot Postponed"
    } else {
        Logs-To-Event -TaskName "AKS.WindowsCSE.StartScheduledTask" -TaskMessage "Setup Complete, start NodeResetScriptTask to register Windows node without reboot"
        Start-ScheduledTask -TaskName "k8s-restart-job"
        Mark "NodeResetScriptTask Started"

        $timeout = 180 ##  seconds
        $timer = [Diagnostics.Stopwatch]::StartNew()
        while ((Get-ScheduledTask -TaskName 'k8s-restart-job').State -ne 'Ready') {
            # The task `k8s-restart-job` needs ~8 seconds.
            if ($timer.Elapsed.TotalSeconds -gt $timeout) {
                Set-ExitCode -ExitCode $global:WINDOWS_CSE_ERROR_START_NODE_RESET_SCRIPT_TASK -ErrorMessage "NodeResetScriptTask is not finished after [$($timer.Elapsed.TotalSeconds)] seconds"
            }

            Write-Log -Message "Waiting on NodeResetScriptTask..."
            Start-Sleep -Seconds 3
        }
        $timer.Stop()
        Write-Log -Message "We waited [$($timer.Elapsed.TotalSeconds)] seconds on NodeResetScriptTask"
        Mark "NodeResetScriptTask Completed"
    }

    Write-Log "NodePrep completed successfully"
    Logs-To-Event -TaskName "AKS.WindowsCSE.NodePrep" -TaskMessage "NodePrep completed successfully"
}

try
{
    Logs-To-Event -TaskName "AKS.WindowsCSE.ExecuteCustomDataSetupScript" -TaskMessage ".\CustomDataSetupScript.ps1 -MasterIP $MasterIP -KubeDnsServiceIp $KubeDnsServiceIp -MasterFQDNPrefix $MasterFQDNPrefix -Location $Location -AADClientId $AADClientId -NetworkAPIVersion $NetworkAPIVersion -TargetEnvironment $TargetEnvironment -CSEResultFilePath $CSEResultFilePath"

    # Exit early if the script has been executed
    if (Test-Path -Path $CSEResultFilePath -PathType Leaf) {
        Write-Log "The script has been executed before, will exit without doing anything."
        return
    }

    # The provisioning is split into two stages to support VHD image creation workflows:
    #
    # Stage 1: Base image preparation
    #   - Installs and configures all required components (kubelet, containerd, etc.)
    #   - Sets up system configurations that are common across all nodes
    #   - DOES NOT join the node to any cluster
    #   - After this stage, users can add customizations (e.g., pre-pull additional container images)
    #   - The VM can then be captured as a VHD image for use as a node pool base image
    #
    # Stage 2: Cluster integration and hardware setup
    #   - Performs cluster-specific configurations
    #   - Configures hardware-specific components (GPU drivers, MIG partitions, etc.)
    #   - Establishes connection to the API server
    #   - Joins the node to the cluster
    #   - Only runs when actually provisioning a node, not when creating VHD images
    #
    # In typical deployments, both stages run sequentially during node provisioning.
    # For VHD image creation workflows, only basePrep runs initially, and nodePrep runs later
    # when nodes are created from that VHD image.
    if (-not (Test-Path "C:\AzureData\base_prep.complete")) {
        BasePrep
    } else {
        Write-Log "Skipping basePrep - base_prep.complete file exists"
    }
    if (-not $PreProvisionOnly) {
        NodePrep
    } else {
        Write-Log "Skipping nodePrep - pre-provision only mode"
    }
}
catch
{
    Resolve-Error
    # Set-ExitCode will exit with the specified ExitCode immediately and not be caught by this catch block
    # Ideally all exceptions will be handled and no exception will be thrown.
    Set-ExitCode -ExitCode $global:WINDOWS_CSE_ERROR_UNKNOWN -ErrorMessage $_
}
finally
{
    # Generate CSE result so it can be returned as the CSE response in csecmd.ps1
    $ExecutionDuration=$(New-Timespan -Start $StartTime -End $(Get-Date))
    Write-Log "CSE ExecutionDuration: $ExecutionDuration. ExitCode: $global:ExitCode"

    Logs-To-Event -TaskName "AKS.WindowsCSE.cse_main" -TaskMessage "ExitCode: $global:ExitCode. ErrorMessage: $global:ErrorMessage."

    # Create appropriate completion file based on mode
    $completionFilePath = if ($PreProvisionOnly) { "C:\AzureData\base_prep.complete" } else { $CSEResultFilePath }

    if ($global:ExitCode -eq 0) {
        Set-Content -Path $completionFilePath -Value $global:ExitCode -Force
    } else {
        # $JsonString = "ExitCode: |{0}|, Output: |{1}|, Error: |{2}|"
        # Max length of the full error message returned by Windows CSE is ~256. We use 240 to be safe.
        $errorMessageLength = "ExitCode: |$global:ExitCode|, Output: |$($global:ErrorCodeNames[$global:ExitCode])|, Error: ||".Length
        $turncatedErrorMessage = $global:ErrorMessage.Substring(0, [Math]::Min(240 - $errorMessageLength, $global:ErrorMessage.Length))
        Set-Content -Path $completionFilePath -Value "ExitCode: |$global:ExitCode|, Output: |$($global:ErrorCodeNames[$global:ExitCode])|, Error: |$turncatedErrorMessage|"
    }

    if ($global:ExitCode -eq $global:WINDOWS_CSE_ERROR_DOWNLOAD_CSE_PACKAGE) {
        Write-Log "Do not call Upload-GuestVMLogs because there is no cse script package downloaded"
    }
    else {
        Upload-GuestVMLogs -ExitCode $global:ExitCode
    }
}
