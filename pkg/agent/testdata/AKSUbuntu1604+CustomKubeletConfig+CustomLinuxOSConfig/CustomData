#cloud-config

write_files:
- path: /opt/azure/containers/provision_redact_cloud_config.py
  permissions: "0744"
  encoding: gzip
  owner: root
  content: !!binary |
    H4sIAAAAAAAA/6xVT2/rNgy/+1MQfQfZaOK8cwEfivYNu2wr3rJTFgiKTTtaZUmT6KbBsO8+SHYS5U+3HpZLZIp/fuSPpGRvjSPYi15l01m4zgrnMcu+wK/kpO7gTagBYfDYABlwaJWoETzWDgkaQSL7/u358Wn57RkqYIczCx6+YyNqgnbQNUmjfdZgCy4K+cYY8uSE5a/DBmujW9lxUp6TeUWd37zeOUnIW6mweMgAAGqjCTXxkAJUMZPSixa5MqL5Lx8rNpmzdXHlbcUGj86z9errejyz9YpFbGwNFRzyjIafD3QA2Qy9zdN4RZal1fHo3mSN3Dqpa2mF4mPBc2+n03Uxbl2dhz6CDuT8JKyHkybzYAVtA8e0RaiNc+it0U3ogQODSRtEZiXBTtJWaqiVGZr5mHpJ75R9geVWevC1kzZoKQVC7cTeH2xpix4TAB5kG4R7wHfpj44DGG+xlq3E5jrMy+PyR778hY+p8R9++/kJKvgrFoQt3oRbKLlZBFoU0uJI1PxEFHv4XEvOJp9IdfTnNBL6hbcBx8nJR8xlf58zHDPhY5A8/eCBhhmYgexA8WPil4TrcJR4qMAj5TeyL19x7/OiyKJNKCIYi/pWCOZYAcJDO/qPI5BqheGGCtrSoWjyaUYSheuJuzKfYLTGJUzDoV8mzRVLuoCtT2hkC2krB9RsHazTUpzUL4oE1Q3rj5R96bA3b5gnsgn84RcYpZyNSy1MxUish9aZPgn1AAzu4cxP6uYGZ6tEeZ0ng52lpVCoU3S+gKqCr+fpbxyK12w0m/A+D70NaMe+u5ghIDPCTdvtonOSqxmw3f3YNJM0JnyEkAjLmEaebLuE8dCemWyBcy165DxkwjjvhdScs9FffIccVMc3qXx03dCjppd4kx+jNjhuGWl0xZ5M3wvdgJIaYSCpJO0v19YHxEGDrdQyPlWxZRncn1XXk8tXdzO4K/8wUt+avmJdwD2ww/IS/7K6Svj9zPky7sMDtH7wBBs8sbbB1ji88gK10EGvNkphVAzAlek6qbuSFUkpS9E0XEw1PFXvbj5Pnc4Dz3ez47XDPwfpsKmWbsCTmPYWK0/uJNmishV7md6QK5zH6n8S09hK/xOa8Iho3Kk9dKjRicsxiAhjxx/rPRHBphkUrgtLd0Id/wJuP63FW0s9XJc31m6Up/P2TwAAAP//QeG0cYgJAAA=

- path: /opt/azure/containers/provision_send_logs.py
  permissions: "0744"
  encoding: gzip
  owner: root
  content: !!binary |
    H4sIAAAAAAAA/5xUUWvbOhR+96/QTR9kQy3byW1oA+ZSSm4p60Zp0qdtBMU6dgSy5Elymqz0vw+pSexsbTeWh3B0/H3nfDrns0/+QUlrdLLkMgG5Rs3WrpQcBQGvG6UtarUQfDk6HFvO9vGmFgSsBiBTATVIO9cAiBo0nQfBytoG5Xs6uVNKfKSSVqDDKAhO0DVYZFeACiUt5RL0gjNEJUMMGqG2rpzLlFrVHnetqEAzSy0ElaJiYVy42NQC5cj1Ihq+tWBsGKDdD19P5/i0OzrUJEmy8TkZj0g2vCDZOKlpseISkv8KVTe5q+wL93groAy0yZ8OGV9tE9cmXoM2XEk8QXiYZsM4y+JRig/AZx9FPcEoR9M5cZcyVnNZhcd3IYxaShgUikGIW1vG5ziKgqMZ5ajjkJJLRoUIMUmu9qAuumE4+px+JRY2NtBKwKJQsuTVQtIa/qDQvRJwI42lsoBbbuxRwuFKXrWaWq7k7vSJ1tDrebzLHP2sgZhGcBti4jnOFg+NUJT5jQtVmeCR2xVSDcgQJ2uqE8GXySOlFUibCFUVSggorNLuYMh33uBThPUSR86HLjfxO3DRwg0X5T4mGigLI/+s9S0XLv22l+4efuulyWh4Nhwn6/rSqbtV1V+Z6CxOL+I063E7ZCE4SBsXSmsQfuyc4QkyVofuvSTu798wit7huqm7TpcfZlez6Z1oKy7f69UTl5KMpK9j947xcvpufQ29rv36hKrizh+eeWSXjvrchUvFtvlhmae79yvgZX+LxFm6NSjP0TBNXwzQaC5tOJi1RQHGlK0Q2x0FmHfE4MUMsOE2TKMAhIE+E/9PuQCGrNrRPAlHPUiJ78E0ShpALwIm6OlXVc9vcdzVJl/kEaX/ORj4z8Eg2hfwSrMo+BEAAP//J6gFusEFAAA=

- path: /opt/azure/manifest.json
  permissions: "0644"
  encoding: gzip
  owner: root
  content: !!binary |
    H4sIAAAAAAAA/8SUXU/bPBiGz/srorw9exc7H001ehZKJtBYigKZNE0ochID1lIbOQ4wqvz3yW5J0tYNG5vE6f3cz5d92auRYRiGmTMqEKGYF+bMWGtKvyEljtASmzPDXLLsp9UZ0/FqvoiugrMojE/Sr2F8ebaImv/Rc82xtRW7CK7mp60DFDgzP3QtCvZIS4aKc5YjQRiVrSC7F7BrBV88lS4xic9lzp0Q99UMQjkmyEqWgZxxDB4JLdhjBSgWKgR31oADa8DxKjlOoqsknS9Owij4EjawJLR+krtfJGkQz0+b3YKD51JnNRV1WzYOz8PgMmzqgfPq99o9uwfMK8JoZc6M762qIg6YAMezvJ57o0+B41uO2crXvXq4uFVX3bp6sRIJXIl11AeOY7n9aCVQVm5yN51VsFl7TF7T/BW0pCUdr+Ikmu/jpNQ3giQL/3uEVFXtuDAjjJL8ECp/uudbAbCBbfH8yN1HYBPx9RAQWglUlnj7K1ifF75BdbmBwAZeV6DZum36QAqCukchdxZE3fUBAl67yIFbO3Qe17qRCk6k5x0H+VFnmFMs8MAQnceirMCWIslCPL8DAnFw+/wXU75AjvLKWhLOGQcKPvn2FeJdc/gwXikWw5P0c3IcpsdnURB/a8mEGaGIE1xB/cB9cPfnHmLXdeUPc8fEDXkCru269tS190GWNl8je+DjbyR7wNE8Din7vWzPdpyJxjYBms/VnYCpVj3SqD5w+1M6tq3L9YGuuw90e0+B3XvTW9ilAi/v5R/+HuiPmtF/4eLT6FcAAAD///cctahuCAAA

- path: /opt/azure/containers/init-aks-custom-cloud.sh
  permissions: "0744"
  encoding: gzip
  owner: root
  content: !!binary |
    

- path: /opt/azure/containers/reconcilePrivateHosts.sh
  permissions: "0744"
  encoding: gzip
  owner: root
  content: !!binary |
    H4sIAAAAAAAA/3SSb0/zNhTF3/tTHEy0AZKblo1JFDLWjaBV/OuI4A1ilUluqEVqB9vp2AP97o+ShpI+EnkTWz7+Hd9z7/ZW+Kh0+CjdjDFHHsJAm0o78h/bUpWUS1Uw9kReyFI5sguyQpUit2YuvHxyO7t4Y0C9jIKdtLIFhEsuIP4GvyQvM+nlEN5WxMFn3pfDMBz8dtjbP/i11/7DeasLlXZe6pTC1MzLylNYY09kqcSCrFNGR/v9waHo/yIGg59yY+fSR55ePd9lgMpxDx6ccEQReJ/j4Qh+RpoBwPgsifgRhyWZQVhZP/hCOY/j42PwoPbhjTA3FgpKgwdvreb+j4clP0JmGkFT6zn931TrITI+5BD5oCYFavdTcyeLin5Q7W+qVA5KZwbBCol3PFkqIdQL+L/y2Y0m46SJfDwZZZkl5wLeKar+mvtCr2poLPn6zJKv7Ic0V80iM5pYu1vf5WzJWHIRx5NpEv91fXWaRIMDlhaV82TP/jm9injwdn77ZzwdTcbTJL65i2+mV6PLeMlZHfs9go4YWxH2eqVVC+mpUPq5t4eHz2Y0rtw9qxKWUqNTVRBmxnnXhL9BckqnBOV/dtDGY3SeoOWildXV0qvy6LNcsRW7Qxhu8Dhj/81qu3oe2462x+NJFOx8PebrARPf1sTxZGPEXEFU1mOzEeRy1Y7UaK90tY5e5W2rX8A7vI3HIiSfhk0yHZtO0wAqHK3Mq8zAUQahwMMuJsy6oE/E17bvK5ongpCdu/gdYUaLUFdF0eHclpn0lG02zptOTPyj6i8jaqaSbcfXZ+x7AAAA//92UkeEmAQAAA==

- path: /etc/systemd/system/reconcile-private-hosts.service
  permissions: "0644"
  encoding: gzip
  owner: root
  content: !!binary |
    H4sIAAAAAAAA/zTOMU4DMRCF4d6n8AUSn2AbBBJ0KAFRrLaYDG/ZkZyxNTOOCKdHAaV8r/m/+V0llvQIZ5Me0nQ6gJuyVOSC4LI1D8/rba/Ncje5UCBzHR6wNB9hF2Es6e3aMbmce0U6wIMspqa7laQOQ3r6Bh//znISLSfyLZfWo9DPMBRuGiQK82J3wOt/6/km2PuW5hf1oFqX9EEa+Hy4TudRQ3bDYfsg+0L8BgAA//8Sy/8V0QAAAA==

- path: /etc/systemd/system/kubelet.service
  permissions: "0600"
  encoding: gzip
  owner: root
  content: !!binary |
    H4sIAAAAAAAA/4yUTU/jPBDH7/4Uoz4c4GD8LLs3lEMLaVXRpagp2kOpKseZUqvOJLLHBXbZ775KX9gtFEROsf37v1iaZHJLlqfiEoPxtmZbUXIVc3TI4qKiwjY7N5oX6aMNHBIVg1euMtqp3JJabtEfmjgkhPxQ+aWsyFnCU9b+HhlMRawtoS9OA/qVNSjac0b/eVxMss3bVIwwsPacaPegn8JumaFJzkRKK+srKpG4ax0mCtmoAuc6On5p+h/0vDY4jw4YfWlJNzeE46zfG6ej7ycii8ZgCOmj5Yw1x5B8+fZVpI9osibqxmOyvnquwwJUVbPSP6NH9dI77LJOw+KArlwW1oOsQa20V87mL9U+wxqy73WRBlp2DhM4Oi6rSAzPcO+xhrvW66S7FjzDgwHpTkA6hP9hCufACyTYxK7lUuaWijc1326cw9y2DrXf2pR6iTIstMe3bmJfJ1VolJizzh0GkAykGw9nAx9Ebf0apViit2Yn+qt6Z3jhTsD2kRKpcZPN5KHfO6GqQOl0ji4kraNfV7eddJCOZ9fDy3Q2aHfSQfa7tSdYJWf768rFEmXt4r0lWVi/GdCmhSdkDGpDbIDwj/ZoFzYeZLPOcDjOxqP2zaw7aPeyQ9jF8Lrb7826/UH6ITRu96/T0eUHTG80vP0gaH0gxKRPgbVz0/V/AIvOU1JGx1bGgH77XYs/AQAA///suTndaQQAAA==



- path: /etc/apt/apt.conf.d/99periodic
  permissions: "0644"
  owner: root
  content: |
    APT::Periodic::Update-Package-Lists "1";
    APT::Periodic::Unattended-Upgrade "1";


- path: /etc/kubernetes/sp.txt
  permissions: "0600"
  encoding: base64
  owner: root
  content: |
    U2VjcmV0CiNFT0Y=




- path: /etc/systemd/system/docker.service.d/exec_start.conf
  permissions: "0644"
  owner: root
  content: |
    [Service]
    ExecStart=
    ExecStart=/usr/bin/dockerd -H fd:// --storage-driver=overlay2 --bip=
    ExecStartPost=/sbin/iptables -P FORWARD ACCEPT
    #EOF

- path: /etc/docker/daemon.json
  permissions: "0644"
  owner: root
  content: |
    {
      "live-restore": true,
      "log-driver": "json-file",
      "log-opts":  {
         "max-size": "50m",
         "max-file": "5"
      }
    }


- path: /etc/systemd/system/sync-tunnel-logs.service
  permissions: "0644"
  owner: root
  content: |
    [Unit]
    Description=Syncs AKS pod log symlinks so that WALinuxAgent can include aks-link/konnectivity/tunnelfront logs.
    After=containerd.service

    [Service]
    ExecStart=/opt/azure/containers/sync-tunnel-logs.sh
    Restart=always

    [Install]
    WantedBy=multi-user.target

- path: /opt/azure/containers/sync-tunnel-logs.sh
  permissions: "0744"
  encoding: gzip
  owner: root
  content: !!binary |
    H4sIAAAAAAAA/5SUUW/bthfF3/kpTh2jbfL/00pSbA8JUmxLvCKAlwyxt2EoioCmriRCFKmRlFNt3ncfSNmO2yQDpif7irw893cOdfAK2VKZbCl8xdj87vIiWwmXaVtm0poglCHn2dV88VgXf3aOMlH7rLW5Z+wAPzhlSiiD2zl3pEWgHLEhVsJ55m3nJCGjIDPr4wISnuK+a+OD0BrK2KCKngdrtYcqECrq3zhCo7yPrQtnm1iEakRJTBX4+BHjv66v/sbFBUaNcFHnCJ8+ncdlhgHSNo0wOfhq2/5BqID3WU6rzHRa4/T96xOs18hNAbVRwvsvxTDSnvCf2ok28JICuMXVz3V5djazsj47W6iGbBcu3h0fD6c8MzorVMQyp4BS2+Uyjm7boKzx8BahEiEKaUsyKJ1Yelij+wRG29LjgfAgTGC+sm0A96DPITZ6LESlqcIO8FscoLAOzziOYEGflQ+JNV6B5xjP7y7xCJhkZcENRrFPMsm6Yc1272QyGTHgoVKavm6SWwYAXhO1OPkm/dl1TNtya2h7zCj+mYw2fH4SNaWhc/JBGREBIVeOZLCuj/kxNkBoRyLv0TryZAJr6lw58Bbjq/kiYQ7CBQgshaxLZzuTo3VWkk/TS03CoGsHsimAOWmK0Y6xT2awA1RiReZNwJLIoLG5KhTl8SqcorKd8xMsKuUhtLYPHl1q7ShSRuiMIR27sYPhFFEEchBw5KO2CRvQBdfRhlihTI4XbiJ46FtCAa6VqT1OwJtGGfzv5PQYfBDPtsjffXt8zCJVvB6Qmk5o3cP3Rka1aESQVbQ1KbNGEosGL365uZnO7me3H+5/vJ5N46Tjt9tM8g8YRYOz796K2icZ66SRS+PXUmnVNevaGkMyqJUK/XpgUDhrwiE/uq+7JXHf+0DN/dFE23J0uI3KkIOZMnUUNf5KRwzM8CHTBnxWPFmQXM/SxGxolewfvlu7+5wSG3FYo4J1KdKyEqYkz/avPf8DvAF34LRJxf+lIxFoyPd6k/kYQFxd300vF7d3v2P66/Rmgahml38pPGG8IZkq8dnCe44I1tghfeH9APqFl/v4X1iyZ8pzKw53Oh8nGEbbG2H7XN5Nv19Mjw6fvMBTT3dGPnn2nR2Nd0SzYUsszRfZv+w/P/+iTF7ITSn+HFLxTwAAAP//FJDA2AoHAAA=





- path: /etc/kubernetes/certs/ca.crt
  permissions: "0600"
  encoding: base64
  owner: root
  content: |
    

- path: /etc/kubernetes/certs/client.crt
  permissions: "0644"
  encoding: base64
  owner: root
  content: |
    

- path: /opt/azure/containers/setup-custom-search-domains.sh
  permissions: "0744"
  encoding: gzip
  owner: root
  content: !!binary |
    H4sIAAAAAAAA/5yQQYsaQRCF7/MrKsZDcmjbFSTXDDpBQVeZUQK5NGVPjXbs6Zauko3Z+N/D7uwlq6dcCurx3uPxffygdy7oHfIhYxJQvzKO52QJev3nSVWYWbFYF2Vlvs0XxTrfzK69d4bpvNqUq3u+jOwhQg+gDqyYMNkD9J8n22qzWpqqyMvJzExXy3z+aB7zZXHtwR8QIlAImsTqQPIU01G7IJQatMSDWo+Hyvp4rpULTga22Wd8YaHWijeJWDAJjIYwhochvBW4sM+e0IlpYjJ4EuOjPXKWSNLFtrVxjWnQ+XOil9AYHkZDwJOo/QuPC7jAgt5DIvRtDczcHSUxegbGdofKxraNoXv+lU4XOcQwGnx5k73bMZzQHnFPRyf3lnXc3qMqi3yxNOu8qr6vyukrrddJ8DO6AGp7w7YLbKuivH7tf7pfesM/gUb1W4PO1Q/9Gf4zl/0NAAD///uJhCVYAgAA
- path: /etc/systemd/system/kubelet.service.d/10-componentconfig.conf
  permissions: "0600"
  encoding: gzip
  owner: root
  content: !!binary |
    H4sIAAAAAAAA/4oOTi0qy0xOjeVyzSvLLMrPy03NK7FV8g51cvVxDYl39vdz83SPd/P0cY1383F0D7bV1U3Oz0vLTFfQTy1J1k9JTUsszSnRzy5NSs1JLYFI6WUV5+cpcQECAAD//wFXt55bAAAA


- path: /var/lib/kubelet/kubeconfig
  permissions: "0644"
  owner: root
  content: |
    apiVersion: v1
    kind: Config
    clusters:
    - name: localcluster
      cluster:
        certificate-authority: /etc/kubernetes/certs/ca.crt
        server: https://:443
    users:
    - name: client
      user:
        client-certificate: /etc/kubernetes/certs/client.crt
        client-key: /etc/kubernetes/certs/client.key
    contexts:
    - context:
        cluster: localcluster
        user: client
      name: localclustercontext
    current-context: localclustercontext
    #EOF

- path: /etc/default/kubelet
  permissions: "0644"
  owner: root
  content: |
    KUBELET_FLAGS=--azure-container-registry-config=/etc/kubernetes/azure.json --cloud-config=/etc/kubernetes/azure.json --cloud-provider=azure 
    KUBELET_REGISTER_SCHEDULABLE=true
    NETWORK_POLICY=
    KUBELET_IMAGE=hyperkube-amd64:v1.16.13


    KUBELET_NODE_LABELS=agentpool=agent2,kubernetes.azure.com/agentpool=agent2

    #EOF

- path: /opt/azure/containers/kubelet.sh
  permissions: "0755"
  owner: root
  content: |
    #!/bin/bash
    # Disallow container from reaching out to the special IP address 168.63.129.16
    # for TCP protocol (which http uses)
    #
    # 168.63.129.16 contains protected settings that have priviledged info.
    #
    # The host can still reach 168.63.129.16 because it goes through the OUTPUT chain, not FORWARD.
    #
    # Note: we should not block all traffic to 168.63.129.16. For example UDP traffic is still needed
    # for DNS.
    iptables -I FORWARD -d 168.63.129.16 -p tcp --dport 80 -j DROP
    #EOF

- path: /etc/sysctl.d/999-sysctl-aks.conf
  permissions: "0644"
  owner: root
  content: |
    # This is a partial workaround to this upstream Kubernetes issue:
    # https://github.com/kubernetes/kubernetes/issues/41916#issuecomment-312428731
    net.ipv4.tcp_retries2=8
    net.core.message_burst=80
    net.core.message_cost=40
    net.core.somaxconn=1638499
    net.ipv4.tcp_max_syn_backlog=1638498
    net.ipv4.neigh.default.gc_thresh1=10001
    net.ipv4.neigh.default.gc_thresh2=10002
    net.ipv4.neigh.default.gc_thresh3=10003

    # The following are sysctl configs passed from API
    net.core.rmem_default=456000
    net.core.wmem_default=89000
    net.ipv4.tcp_tw_reuse=1
    net.ipv4.ip_local_port_range=32768 60999
    #EOF

runcmd:
- set -x
- . /opt/azure/containers/provision_source.sh
- . /opt/azure/containers/provision_source_distro.sh
- aptmarkWALinuxAgent hold