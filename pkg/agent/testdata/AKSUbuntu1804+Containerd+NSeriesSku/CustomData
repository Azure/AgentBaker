#cloud-config

write_files:
- path: /opt/azure/containers/provision_source.sh
  permissions: "0744"
  encoding: gzip
  owner: root
  content: !!binary |
    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

- path: /opt/azure/containers/provision_start.sh
  permissions: "0744"
  encoding: gzip
  owner: root
  content: !!binary |
    H4sIAAAAAAAA/5SSX4vTQBTF3/MpDmG0CXaM1bdCK0s6SAVbaVLYByFMJ9c2GjNx/ixV1+8u6fYf7lpqniacO7/DnHOTVdUkK2k3SHTrEvnTG0qUbpysGjI2aY2+q2ylm5d2g/EYyZ00Sa3Xh8naW0eGn8Zqvcbr8fNBIG6neZHOJ2LE3gb2h3X0TbkanDeat3JNBryGddJ5i69+RTW5awy4ssS1d613J6/5Mv+4zEcsUtL9N+EeG5IleIM3r+Igy28WeZFPP4gRi0htNEL2gA9xD+UdeIlevwf+GXxwvDyIgzQThbgV6TKfzmfFZLm46Q4HCosiFpXSEV48szE49n+8RMhOpuFOjuM4ePBOM4FcO1lDbEl5V+kGE29kdxiypy0BS0o3pQ2vCpQOYF7uwfa8xb/p2bUx/4MbB8H7bD4rsnwxnb0bsQhfvnfhfwrw6ONcmjVIIWTHdQovTOr2rK0LQIPwol7uDB+9/Ok7vV9iW7lUlzQEI9XHfLdbQzDd9iGM0aYTTB9pJo4tHkq0nVb+7mHfODsLJ6Bt5XB6+p8AAAD//9CDYZutAwAA

- path: /opt/azure/containers/provision.sh
  permissions: "0744"
  encoding: gzip
  owner: root
  content: !!binary |
    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

- path: /opt/azure/containers/provision_installs.sh
  permissions: "0744"
  encoding: gzip
  owner: root
  content: !!binary |
    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

- path: /opt/azure/containers/provision_configs.sh
  permissions: "0744"
  encoding: gzip
  owner: root
  content: !!binary |
    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







- path: /etc/systemd/system/kubelet.service
  permissions: "0644"
  encoding: gzip
  owner: root
  content: !!binary |
    H4sIAAAAAAAA/4ySz0/bThDF7/4rRhGH7/ewbOmPS5EPUAyNiCjCQRxChNbrgYyynnV3Z0No6f9emRAgYKT6ZM++z5vn1ZucM8k0O8BoA7VCnvPjVKFDyb55rqmbnBqZFUuKEnOdYtDOW+N0Raznj9Ism5QYFmRxmp1hFBMkN+7W3MWs4AUFzw2yHJLDXKNYXeO1SU6e+DJZizEWS5JSjKSY73z+lBVLtGXndRowf9hXmTgD7VvR5lcKqK1nMcQY4tpqO856uGZeUwDVgl6YoB1VT5v/RWuZ3suiLAzoGiaw9V/jEwvcw03AFi4HrzddDuAebi0o9z8oh/ABprALMkOG1doHXKmKuH4T8+1gF65p0Jf+0aYxc1RxZgK+dcs2OaVjR2IlpnIYQQmw6TwcRemVUvtayqnBQHYNPVPvNAYuM3h8lELu3FTEsMCwccK+RuVMhS7mg63fx+f7xagYX538OCiuRnv7xaj8M9gAFvlHUOqpFiokFmowD9h4QVDrgQr4M2EU1X34JPnOl6YPVMh164klT0zLr1rrkPi5dvWL1+3o7XwzjHepQdW6dEOsagqr8ndXEBgFo14pVoL4gt1a/+nhaO+o7Ds4K46G5bg4e7iLnvHFcPz9arw3PBmXWTYZchTj3DS7MCxY79/lTXJCKkUM22LCDcrfAAAA//8PqjOJCQQAAA==



- path: /etc/apt/apt.conf.d/99periodic
  permissions: "0644"
  owner: root
  content: |
    APT::Periodic::Update-Package-Lists "0";
    APT::Periodic::Download-Upgradeable-Packages "0";
    APT::Periodic::AutocleanInterval "0";
    APT::Periodic::Unattended-Upgrade "0";








- path: /etc/containerd/config.toml
  permissions: "0644"
  owner: root
  content: |
    version = 2
    subreaper = false
    oom_score = 0
    [plugins."io.containerd.grpc.v1.cri"]
      sandbox_image = "oss/kubernetes/pause:1.3.1"
      [plugins."io.containerd.grpc.v1.cri".containerd]
        
        [plugins."io.containerd.grpc.v1.cri".containerd.untrusted_workload_runtime]
          runtime_type = "io.containerd.runtime.v1.linux"
          runtime_engine = "/usr/bin/nvidia-container-runtime"
        [plugins."io.containerd.grpc.v1.cri".containerd.default_runtime]
          runtime_type = "io.containerd.runtime.v1.linux"
          runtime_engine = "/usr/bin/nvidia-container-runtime"
      
      [plugins."io.containerd.grpc.v1.cri".registry.headers]
        X-Meta-Source-Client = ["azure/aks"]
    [metrics]
      address = "127.0.0.1:10257"
    
    #EOF

- path: /etc/containerd/kubenet_template.conf
  permissions: "0644"
  owner: root
  content: |
      {
          "cniVersion": "0.3.1",
          "name": "kubenet",
          "plugins": [{
            "type": "bridge",
            "bridge": "cbr0",
            "mtu": 1500,
            "addIf": "eth0",
            "isGateway": true,
            "ipMasq": true,
            "promiscMode": true,
            "hairpinMode": false,
            "ipam": {
                "type": "host-local",
                "subnet": "{{.PodCIDR}}",
                "routes": [{ "dst": "0.0.0.0/0" }]
            }
          },
          {
            "type": "portmap",
            "capabilities": {"portMappings": true},
            "externalSetMarkChain": "KUBE-MARK-MASQ"
          }]
      }

- path: /etc/systemd/system/containerd.service
  permissions: "0644"
  owner: root
  content: |
    [Unit]
    Description=containerd daemon
    After=network.target

    [Service]
    ExecStartPre=/sbin/modprobe overlay
    ExecStart=/usr/bin/containerd
    Delegate=yes
    KillMode=process
    Restart=always
    OOMScoreAdjust=-999
    LimitNOFILE=1048576
    LimitNPROC=infinity
    LimitCORE=infinity

    [Install]
    WantedBy=multi-user.target

    #EOF

- path: /etc/systemd/system/containerd.service.d/exec_start.conf
  permissions: "0644"
  owner: root
  content: |
    [Service]
    ExecStartPost=/sbin/iptables -P FORWARD ACCEPT
    #EOF

- path: /etc/crictl.yaml
  permissions: "0644"
  owner: root
  content: |
    runtime-endpoint: unix:///run/containerd/containerd.sock
    #EOF

- path: /etc/sysctl.d/11-containerd.conf
  permissions: "0644"
  owner: root
  content: |
    net.ipv4.ip_forward = 1
    net.ipv4.conf.all.forwarding = 1
    net.bridge.bridge-nf-call-iptables = 1
    #EOF



- path: /opt/azure/containers/ensure_no_dup.sh
  permissions: "0755"
  owner: root
  content: |
    #!/bin/bash

    # remove this if we are no longer using promiscuous bridge mode for containerd
    # background: we get duplicated packets from pod to serviceIP if both are on the same node (one from the cbr0 bridge and one from the pod ip itself via kernel due to promiscuous mode being on)
    # we should filter out the one from pod ip
    # this is exactly what kubelet does for dockershim+kubenet
    # https://github.com/kubernetes/kubernetes/pull/28717
    for try in {1..10}; do
      ebtables -t filter -L AKS-DEDUP 2>/dev/null
      if [[ $? -eq 0 ]]; then
        echo "AKS-DEDUP rule already set"
        exit 0
      fi
      if [[ ! -f /etc/cni/net.d/10-containerd-net.conflist ]]; then
        echo "cni config not up yet...checking again in 5s"
        sleep 5
        continue
      fi
      podSubnetAddr=$(cat /etc/cni/net.d/10-containerd-net.conflist  | jq -r ".plugins[] | select(.type == \"bridge\") | .ipam.subnet")

      if [[ ! -f /sys/class/net/cbr0/address ]]; then
        echo "cbr0 bridge not up yet...checking again in 5s"
        sleep 5
        continue
      fi
      cbr0MAC=$(cat /sys/class/net/cbr0/address)

      cbr0IP=$(ip addr show cbr0 | grep -Eo "inet ([0-9]*\.){3}[0-9]*" | grep -Eo "([0-9]*\.){3}[0-9]*")
      if [[ -z "${cbr0IP}" ]]; then
        echo "cbr0 bridge does not have an ipv4 address...checking again in 5s"
        sleep 5
        continue
      fi

      ebtables -t filter -N AKS-DEDUP # add new AKS-DEDUP chain
      ebtables -t filter -A AKS-DEDUP -p IPv4 -s ${cbr0MAC} -o veth+ --ip-src ${cbr0IP} -j ACCEPT
      ebtables -t filter -A AKS-DEDUP -p IPv4 -s ${cbr0MAC} -o veth+ --ip-src ${podSubnetAddr} -j DROP
      ebtables -t filter -A OUTPUT -j AKS-DEDUP # add new rule to OUTPUT chain jump to AKS-DEDUP
      exit 0
    done
    exit 1
    #EOF



- path: /etc/systemd/system/nvidia-modprobe.service
  permissions: "0644"
  owner: root
  content: |
    [Unit]
    Description=Installs and loads Nvidia GPU kernel module
    [Service]
    Type=oneshot
    RemainAfterExit=true
    ExecStartPre=/bin/sh -c "dkms autoinstall --verbose"
    ExecStart=/bin/sh -c "nvidia-modprobe -u -c0"
    ExecStartPost=/bin/sh -c "sleep 10 && systemctl restart kubelet"
    [Install]
    WantedBy=multi-user.target


- path: /etc/kubernetes/certs/ca.crt
  permissions: "0644"
  encoding: base64
  owner: root
  content: |
    

- path: /etc/kubernetes/certs/client.crt
  permissions: "0644"
  encoding: base64
  owner: root
  content: |
    



- path: /var/lib/kubelet/kubeconfig
  permissions: "0644"
  owner: root
  content: |
    apiVersion: v1
    kind: Config
    clusters:
    - name: localcluster
      cluster:
        certificate-authority: /etc/kubernetes/certs/ca.crt
        server: https://:443
    users:
    - name: client
      user:
        client-certificate: /etc/kubernetes/certs/client.crt
        client-key: /etc/kubernetes/certs/client.key
    contexts:
    - context:
        cluster: localcluster
        user: client
      name: localclustercontext
    current-context: localclustercontext
    #EOF

- path: /etc/default/kubelet
  permissions: "0644"
  owner: root
  content: |
    KUBELET_FLAGS=
    KUBELET_REGISTER_SCHEDULABLE=true
    NETWORK_POLICY=
    KUBELET_IMAGE=hyperkube-amd64:v1.15.7


    KUBELET_NODE_LABELS=kubernetes.azure.com/role=agent,node-role.kubernetes.io/agent=,kubernetes.io/role=agent,agentpool=agent2,storageprofile=managed,storagetier=Standard_LRS,accelerator=nvidia,kubernetes.azure.com/cluster=resourceGroupName

    #EOF

- path: /opt/azure/containers/kubelet.sh
  permissions: "0755"
  owner: root
  content: |
    #!/bin/bash

    


    # Disallow container from reaching out to the special IP address 168.63.129.16
    # for TCP protocol (which http uses)
    #
    # 168.63.129.16 contains protected settings that have priviledged info.
    #
    # The host can still reach 168.63.129.16 because it goes through the OUTPUT chain, not FORWARD.
    #
    # Note: we should not block all traffic to 168.63.129.16. For example UDP traffic is still needed
    # for DNS.
    iptables -I FORWARD -d 168.63.129.16 -p tcp --dport 80 -j DROP
    #EOF

- path: /etc/sysctl.d/999-sysctl-aks.conf
  permissions: "0644"
  owner: root
  content: |
    # This is a partial workaround to this upstream Kubernetes issue:
    # https://github.com/kubernetes/kubernetes/issues/41916#issuecomment-312428731
    net.ipv4.tcp_retries2=8
    net.core.message_burst=80
    net.core.message_cost=40
    net.core.somaxconn=16384
    net.ipv4.tcp_max_syn_backlog=16384
    net.ipv4.neigh.default.gc_thresh1=4096
    net.ipv4.neigh.default.gc_thresh2=8192
    net.ipv4.neigh.default.gc_thresh3=16384

    #EOF

runcmd:
- set -x
- . /opt/azure/containers/provision_source.sh
- aptmarkWALinuxAgent hold
